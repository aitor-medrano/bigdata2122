
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://aitor-medrano.github.io/bigdata2122/apuntes/ingesta04nifi2.html">
      
      <link rel="icon" href="../imagenes/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.0.2">
    
    
      
        <title>Nifi Avanzado - Inteligencia Artificial y Big Data</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.816931ca.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.9204c3b2.min.css">
        
          
          
          <meta name="theme-color" content="#02a6f2">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>function __md_scope(e,t,_){return new URL(_||(t===localStorage?"..":".."),location).pathname+"."+e}function __md_get(e,t=localStorage,_){return JSON.parse(t.getItem(__md_scope(e,t,_)))}function __md_set(e,t,_=localStorage,o){try{_.setItem(__md_scope(e,_,o),JSON.stringify(t))}catch(e){}}</script>
    
      

  


  

  


  <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MV889H0W63"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-MV889H0W63",{page_path:e.pathname})})})</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MV889H0W63"></script>


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="light-blue" data-md-color-accent="teal">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#nifi-avanzado" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-header__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../imagenes/logoIABD3.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inteligencia Artificial y Big Data
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Nifi Avanzado
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-nav__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../imagenes/logoIABD3.png" alt="logo">

    </a>
    Inteligencia Artificial y Big Data
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Inicio
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Arquitecturas Big Data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Arquitecturas Big Data" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Arquitecturas Big Data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube01.html" class="md-nav__link">
        1.- Cloud Computing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube02aws.html" class="md-nav__link">
        2.- AWS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube03computacion.html" class="md-nav__link">
        3.- Computación
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube04almacenamiento.html" class="md-nav__link">
        4.- Almacenamiento
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube05datos.html" class="md-nav__link">
        5.- Datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="arquitecturas01.html" class="md-nav__link">
        6.- Arquitecturas
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Ingesta de Datos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ingesta de Datos" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Ingesta de Datos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="ingesta01.html" class="md-nav__link">
        1.- ETL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="ingesta02pentaho.html" class="md-nav__link">
        2.- Pentaho DI
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#grupos" class="md-nav__link">
    Grupos
  </a>
  
    <nav class="md-nav" aria-label="Grupos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creando-un-grupo" class="md-nav__link">
    Creando un grupo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#puertos" class="md-nav__link">
    Puertos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#funnels" class="md-nav__link">
    Funnels
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plantillas" class="md-nav__link">
    Plantillas
  </a>
  
    <nav class="md-nav" aria-label="Plantillas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creando-plantillas" class="md-nav__link">
    Creando plantillas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cargando-plantillas" class="md-nav__link">
    Cargando plantillas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-5-trabajando-con-conjuntos-de-registros" class="md-nav__link">
    Caso 5: Trabajando con conjuntos de registros
  </a>
  
    <nav class="md-nav" aria-label="Caso 5: Trabajando con conjuntos de registros">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#convirtiendo-formatos" class="md-nav__link">
    Convirtiendo formatos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#renombrando-el-destino" class="md-nav__link">
    Renombrando el destino
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-6-trabajando-con-elasticsearch" class="md-nav__link">
    Caso 6: Trabajando con Elasticsearch
  </a>
  
    <nav class="md-nav" aria-label="Caso 6: Trabajando con Elasticsearch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#separando-los-datos" class="md-nav__link">
    Separando los datos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-6-de-twitter-a-elasticsearch" class="md-nav__link">
    Caso de uso 6: de Twitter a Elasticsearch
  </a>
  
    <nav class="md-nav" aria-label="Caso de uso 6: de Twitter a Elasticsearch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#leyendo-tweets" class="md-nav__link">
    Leyendo tweets
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluando-el-idioma" class="md-nav__link">
    Evaluando el idioma
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#particionando-los-datos" class="md-nav__link">
    Particionando los datos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-7-kafka" class="md-nav__link">
    Caso de uso 7: Kafka
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-z-twitter-kafka-mongodb" class="md-nav__link">
    Caso de uso Z: Twitter + Kafka + MongoDB
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="nifi-avanzado">Nifi Avanzado<a class="headerlink" href="#nifi-avanzado" title="Permanent link">&para;</a></h1>
<p align="right"><small>Tiempo estimado de lectura: XX minutos [7 de Febrero]</small></p>

<h2 id="grupos">Grupos<a class="headerlink" href="#grupos" title="Permanent link">&para;</a></h2>
<p>En Nifi sólo hay un canvas de nivel superior, pero podemos construir tantos flujos lógicos como deseemos. Normalmente, para organizar las flujos, se utilizan <strong>grupos de procesos</strong>, por lo que el canvas de nivel superior puede tener varios grupos de procesos, cada uno de los cuales representa un flujo lógico, pero no necesariamente conectados entre sí.</p>
<figure style="float: right;">
    <img src="../imagenes/etl/04caso0menu.png">
    <figcaption>Trabajando con grupos</figcaption>
</figure>

<p>Dentro de los grupos, para indicar como entran los datos se utiliza un <em>Input port</em>, el cual va a definir un <strong>puerto de entrada</strong> al grupo. Del mismo modo, para indicar como salen los datos, se utiliza un <em>Output port</em> como <strong>puerto de salida</strong> para transferir la información fuera del grupo.</p>
<p>Así pues, los grupos de procesos nos van a permitir refactorizar nuestros flujos para agruparlos y poder reutilizarlos en otros flujos, o bien mejorar la legibilidad de nuestro flujo de datos.</p>
<p>En todo momento podemos ver el nivel en el que nos encontramos en la parte inferior izquierda, con una notación similar a <code>Nifi Flow &gt;&gt; Subnivel &gt;&gt; Otro Nivel</code>.</p>
<h3 id="creando-un-grupo">Creando un grupo<a class="headerlink" href="#creando-un-grupo" title="Permanent link">&para;</a></h3>
<p>Vamos a partir de un ejemplo sencillo de leer un fichero de texto, partirlo en fragmentos y nos saque por el log alguno de sus atributos.</p>
<p>Para ello, vamos a conectar un procesador <em>GetFile</em> con un <em>SplitText</em> y finalmente con <em>LogAttribute</em>.
El procesador <em>SplitText</em> nos permite dividir cualquier flujo de texto en fragmentos a partir del número de líneas que queramos (pudiendo tener encabezados, ignorar las líneas en blanco, etc...)</p>
<figure style="align: center;">
    <img src="../imagenes/etl/04caso0.png">
    <figcaption>Dividimos un archivo en fragmentos</figcaption>
</figure>

<p>Para probarlo, podemos copiar cualquier archivo (ya sea el <code>README</code> o el <code>NOTICE</code>) en la carpeta que hayamos indicado de entrada y comprobar el log.</p>
<p>Una vez lo tenemos funcionando, vamos a colocar el procesador <em>SplitText</em> dentro de un grupo. Así pues, un grupo encapsula la lógica de un procesador haciéndolo funcionar como una caja negra.</p>
<p>Para ello, desde la barra superior arrastramos el icono de <em>Process Group</em> y lo nombramos como <em>grupo</em>.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/04caso0group.gif">
    <figcaption>Creación de un grupo</figcaption>
</figure>

<h3 id="puertos">Puertos<a class="headerlink" href="#puertos" title="Permanent link">&para;</a></h3>
<p>Una vez creado, vamos a copiar nuestro procesador <em>SplitText</em>. Pulsamos doble click sobre el grupo y bajaremos un nivel en el canvas para meternos dentro de <em>Grupo</em>. Una vez dentro, vamos a pegar el procesador y añadiremos tanto un <em>Input port</em> (al que nombramos como <em>entrada</em>) como un <em>Output port</em> (al que llamamos <em>salida</em>). Una vez creados, los conectamos con el procesador con las mismas conexiones que antes.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/04caso0groupFlujos.gif">
    <figcaption>Grupo con puertos de entrada y salida</figcaption>
</figure>

<p>Ahora salimos del grupo, y conectamos los procesadores del nivel superior con el grupo creado y comprobamos como sigue funcionando.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/04caso0completo.png">
    <figcaption>Sustituimos el procesador por el grupo creado</figcaption>
</figure>

<h2 id="funnels">Funnels<a class="headerlink" href="#funnels" title="Permanent link">&para;</a></h2>
<figure style="float: right;">
    <img src="../imagenes/etl/04Funnel.png" width="80">
    <figcaption>Funnel</figcaption>
</figure>

<p>Los <em>funnels</em> son un tipo de componente que permite trabajar en paralelo y después unir los diferentes flujos en un único flujo de ejecución, además de poder definir su propia prioridad de forma centralizada.</p>
<p>Para ello vamos a poner varios <em>GenerateFlowFile</em> (4 en este caso) para mostrar sus datos mediante <em>LogAttribute</em>.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/04caso0GenerateFF.png">
    <figcaption>Varios procesadores que apuntan a uno</figcaption>
</figure>

<p>Si quisiéramos cambiar el procesador de <em>LogAttribute</em> por otro tipo de procesador, deberiamos borrar todas las conexiones y volver a conectarlo todo. Para evitar esto añadimos un <em>Funnel</em> que va a centralizar todas las conexiones en un único punto.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/04caso0Funnel.png">
    <figcaption>El Funnel agrupa las conexiones</figcaption>
</figure>

<h2 id="plantillas">Plantillas<a class="headerlink" href="#plantillas" title="Permanent link">&para;</a></h2>
<p>Nifi permite trabajar con plantillas para poder reutilizar flujos de datos, así como importar y exportar nuestras plantillas.</p>
<h3 id="creando-plantillas">Creando plantillas<a class="headerlink" href="#creando-plantillas" title="Permanent link">&para;</a></h3>
<p>Crear una plantilla es muy sencillo. Si partimos del ejemplo anterior, mediante shift y el ratón, podemos seleccionar todos los elementos que queremos que formen parte de la plantilla.</p>
<p>Una vez seleccionado, podemos utilizar el botón derecho o dentro del menú <em>Operate</em>, y elegir <em>Create Template</em>:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/04Template.gif">
    <figcaption>Creación de una plantilla</figcaption>
</figure>

<p>Si queremos descargar una plantilla para usarla en otra instalación, desde el menú de la esquina superior derecha, en la opción <em>Templates</em>, podemos consultar las plantillas que tenemos cargadas, y para cada una de ellas, tenemos la opción de descargarlas o eliminarlas.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/04TemplateDownload.gif">
    <figcaption>Descargando una plantilla</figcaption>
</figure>

<h3 id="cargando-plantillas">Cargando plantillas<a class="headerlink" href="#cargando-plantillas" title="Permanent link">&para;</a></h3>
<p>En cambio, para cargar una plantilla, desde el propio menú de <em>Operate</em>, el icono con la plantilla y la flecha hacia arriba, nos permitirá elegir un archivo <code>.xml</code> con el código de la plantilla.</p>
<p>Una vez cargada, usaremos el control del menu superior para arrastrarla al área de trabajo.</p>
<p>Una de las mayores ventajas es el uso de plantillas ya existentes. Existe una colección de plantillas mantenida por <em>Cloudera</em> en <a href="https://github.com/hortonworks-gallery/nifi-templates">https://github.com/hortonworks-gallery/nifi-templates</a>. Se recomienda darle un ojo a la <a href="https://github.com/hortonworks-gallery/nifi-templates/blob/master/NiFi%20Templates.xlsx">hoja de cálculo</a> que contiene un resumen de las plantillas compartidas.</p>
<p>Otros ejemplos a destacar se encuentran en <a href="https://github.com/xmlking/nifi-examples">https://github.com/xmlking/nifi-examples</a>.</p>
<p>En nuestro caso, vamos a utilizar la plantilla de <em>CSV-to-JSON</em>, la cual podemos descargar desde <a href="https://raw.githubusercontent.com/hortonworks-gallery/nifi-templates/master/templates/csv-to-json-flow.xml">https://raw.githubusercontent.com/hortonworks-gallery/nifi-templates/master/templates/csv-to-json-flow.xml</a>.</p>
<p>Una vez descargado el archivo xml, lo subimos a Nifi. Tras ello, arrastramos el componente y vemos su resultado:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/04TemplateUpload.gif">
    <figcaption>Cargando una plantilla</figcaption>
</figure>

<h2 id="caso-5-trabajando-con-conjuntos-de-registros">Caso 5: Trabajando con conjuntos de registros<a class="headerlink" href="#caso-5-trabajando-con-conjuntos-de-registros" title="Permanent link">&para;</a></h2>
<p>En los casos anteriores, ya hemos visto que haciendo uso de <em>ExtractText</em> y <em>AttributesToJSON</em> podíamos crear ficheros JSON a partir de CSV.</p>
<p>Nifi ofrece una forma más cómoda de realizar esto. Haciendo uso de los FF como registros y los procesadores de tipo <em>Record</em> (ya utilizamos alguno en el caso 3, en el que filtrabamos mediante una sentencia SQL), vamos a poder trabajar con los datos como un conjunto de registros en vez de hacerlo de forma individual.</p>
<p>Estos procesadores hacen que los flujos de construcción para manejar datos sean más sencillos, ya que que podemos construir procesadores que acepten cualquier formato de datos sin tener que preocuparnos por el análisis y la lógica de serialización. Otra gran ventaja de este enfoque es que podemos mantener los FF más grandes, cada uno de los cuales consta de múltiples registros, lo que resulta en un mejor rendimiento.</p>
<p>Tenemos tres componentes a destacar:</p>
<ul>
<li>De lectura: <code>AvroReader</code>, <code>CsvReader</code>, <code>ParquetReader</code>, <code>JsonPathReader</code>, <code>JsonTreeReader</code>, <code>ScriptedReader</code>, ...</li>
<li>De escritura: <code>AvroRecordSetWriter</code>, <code>CsvRecordSetWriter</code>, <code>JsonRecordSetWriter</code>, <code>FreeFormTextRecordSetWriter</code>, <code>ScriptedRecordSetWriter</code>, ...</li>
<li>Procesador de registros:<ul>
<li><code>ConvertRecord</code>, que convierte entre formatos y/o esquemas similares. Por ejemplo, la conversión de CSV a Avro se puede realizar configurando <code>ConvertRecord</code> con un <code>CsvReader</code> y un <code>AvroRecordSetWriter</code>. Además, la conversión de esquemas entre esquemas similares se puede realizar cuando el esquema de escritura es un subconjunto de los campos del esquema de lectura o si el esquema de escritura tiene campos adicionales con valores propuestos.</li>
<li><code>LookupRecord</code>, que extrae uno o más campos de un registro y busca un valor para esos campos en un <code>LookupService</code> (ya sea a un fichero CSV, XML, accediendo a una base de datos o un servicio REST, etc...). Estos servicios funcionan como un mapa, de manera que reciben la clave y el servicio devuelve el valor. Puedes consultar más información en la serie de artículos <a href="https://community.cloudera.com/t5/Community-Articles/Data-flow-enrichment-with-NiFi-part-1-LookupRecord-processor/ta-p/246940">Data flow enrichment with NiFi part: LookupRecord processor</a> y un ejemplo completo en <a href="https://alasdairb.com/2021/05/16/enriching-records-with-lookuprecord-rest-apis-in-nifi/">Enriching Records with LookupRecord &amp; REST APIs in NiFi</a>.</li>
<li><code>QueryRecord</code>, que ejecuta una declaración SQL contra los registros y escribe los resultados en el contenido del archivo de flujo. Este es el procesador que usamos en el caso 3.</li>
<li><code>ConsumeKafkaRecord_N_M</code>;, este procesador utiliza el <em>Reader</em> de registros configurado para deserializar los datos sin procesar recuperados de Kafka, y luego utiliza el <em>Writer</em> de registros configurado para serializar los registros al contenido del archivo de flujo.</li>
<li><code>PublicarKafkaRecord_N_M</code>, este procesador utiliza el  <em>Reader</em> de registros configurado para leer el archivo de flujo entrante como registros, y luego utiliza el <em>Writer</em> de registros configurado para serializar cada registro para publicarlo en Kafka.</li>
</ul>
</li>
</ul>
<h3 id="convirtiendo-formatos">Convirtiendo formatos<a class="headerlink" href="#convirtiendo-formatos" title="Permanent link">&para;</a></h3>
<p>Así pues, para demostrar su uso vamos a convertir el archivo CSV del caso 3 que contiene información sobre <a href="../recursos/pdi_sales_small.csv">ventas</a> a formato JSON.</p>
<p>Podríamos utilizar simplemente un <em>GetFile</em> conectado a un <em>ConvertRecord</em> y este a un <em>PutFile</em>. Para que el fichero generado contenga como extensión el formato al que convertimos, antes de serializar los datos, añadimos un procesador <em>UpdateAttribute</em> para modificar el nombre del fichero.</p>
<p>El flujo de datos resultante será similar a:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/04caso5completo.png">
    <figcaption>Conversión de formato mediante ConvertRecord</figcaption>
</figure>

<p>En concreto, en el caso del <em>ConvertRecord</em>, hemos utilizado los siguientes elementos:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/04caso5configureRecord.png">
    <figcaption>Configuración de ConvertRecord</figcaption>
</figure>

<p>Para el <em>CSVReader</em>, hemos de configurar el separador de campos con el <code>;</code> e indicar que la primera fila contiene un encabezado. Para el <em>JSONRecordSetWriter</em> no hemos configurado nada.</p>
<h3 id="renombrando-el-destino">Renombrando el destino<a class="headerlink" href="#renombrando-el-destino" title="Permanent link">&para;</a></h3>
<p>Tal como hemos comentado, necesitamos renombrar el fichero de salida. Para ello, necesitamos hacer uso del procesador <em>UpdateAttribute</em> y utilizar el <a href="https://nifi.apache.org/docs/nifi-docs/html/expression-language-guide.html">Nifi Expression Language</a> para modificar la propiedad <code>filename</code> y recortar la extensión y concatenar con la nueva mediante la expresión <code>${filename:substringBefore('.csv')}.json</code>:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/04caso5renameFilename.png">
    <figcaption>Modificando la extensión de filename</figcaption>
</figure>

<h2 id="caso-6-trabajando-con-elasticsearch">Caso 6: Trabajando con Elasticsearch<a class="headerlink" href="#caso-6-trabajando-con-elasticsearch" title="Permanent link">&para;</a></h2>
<p>En bloques anteriores ya hemos trabajado con <em>Elasticsearch</em>. En nuestro caso, tenemos la versión 7.15 descargada en el escritorio de nuestra máquina virtual.</p>
<div class="admonition tip">
<p class="admonition-title">Elasticsearch+Nifi via Docker</p>
<p>Si queremos utilizarlo mediante Docker, necesitamos que ElasticSearch y Nifi estén dentro del mismo contenedor. Para ello, podemos configurarlo mediante el siguiente archivo <a href="../recursos/nifi-elastic/docker-compose.yml">docker-compose.yml</a>:</p>
<div class="highlight"><span class="filename">docker-compose.yml</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nt">services</span><span class="p">:</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="nt">nifi</span><span class="p">:</span>
<span class="linenos" data-linenos=" 3 "></span>        <span class="nt">ports</span><span class="p">:</span>
<span class="linenos" data-linenos=" 4 "></span>            <span class="p p-Indicator">-</span> <span class="s">&quot;8443:8443&quot;</span>
<span class="linenos" data-linenos=" 5 "></span>        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apache/nifi:latest</span>
<span class="linenos" data-linenos=" 6 "></span>        <span class="nt">environment</span><span class="p">:</span>
<span class="linenos" data-linenos=" 7 "></span>            <span class="nt">SINGLE_USER_CREDENTIALS_USERNAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nifi</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="nt">SINGLE_USER_CREDENTIALS_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nifinifinifi</span>
<span class="linenos" data-linenos=" 9 "></span>        <span class="nt">links</span><span class="p">:</span>
<span class="linenos" data-linenos="10 "></span>            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">elasticsearch</span>
<span class="linenos" data-linenos="11 "></span>    <span class="nt">elasticsearch</span><span class="p">:</span>
<span class="linenos" data-linenos="12 "></span>        <span class="nt">ports</span><span class="p">:</span>
<span class="linenos" data-linenos="13 "></span>            <span class="p p-Indicator">-</span> <span class="s">&quot;9200:9200&quot;</span>
<span class="linenos" data-linenos="14 "></span>            <span class="p p-Indicator">-</span> <span class="s">&quot;9300:9300&quot;</span>
<span class="linenos" data-linenos="15 "></span>        <span class="nt">environment</span><span class="p">:</span>
<span class="linenos" data-linenos="16 "></span>            <span class="nt">discovery.type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">single-node</span>
<span class="linenos" data-linenos="17 "></span>        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker.elastic.co/elasticsearch/elasticsearch:7.15.2</span>
</code></pre></div>
<p>Una vez creado el archivo, construimos el contenedor mediante:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>docker-compose -p nifielasticsearch up -d
</code></pre></div>
</div>
<p>Recordad que necesitamos arrancarla mediante el comando <code>./bin/elasticsearch</code>. Para comprobar que ha ido todo bien, podemos ejecutar la siguiente petición:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>curl -X GET <span class="s1">&#39;localhost:9200/_cat/health?v=true&amp;pretty&#39;</span>
</code></pre></div>
<p>El procesador con el que vamos a trabajar es del tipo <em>PutElasticSearchHttp</em>, en el cual vamos a configurar:</p>
<ul>
<li><em>Elasticsearch URL</em>: <code>http://localhost:9200</code></li>
<li><em>Index</em>: aquí vamos a poner como valor la palabra <code>peliculas</code>.</li>
<li>marcamos la opción de autoterminar para las conexiones <em>retry</em> y <em>failure</em>.</li>
</ul>
<p>Una vez creado el procesador, vamos a alimentarlo a partir de los datos de un fichero JSON, mediante el procesador que ya conocemos <em>GetFile</em>. Podéis descargar el fichero de pruebas <a href="../recursos/movies.json">movies.json</a> y colocarlo en la carpeta donde hayamos configurado.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/04caso6Lectura.png">
    <figcaption>Lectura de JSON e inserción en Elasticsearch</figcaption>
</figure>

<p>Una vez ejecutado, para comprobar que se han introducido los datos podemos ejecutar la siguiente petición:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>curl -X  GET <span class="s2">&quot;localhost:9200/peliculas/_search?pretty&quot;</span>
</code></pre></div>
<p>Y veremos cómo se han introducido en Elasticsearch:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span><span class="nt">&quot;took&quot;</span><span class="p">:</span> <span class="mi">46</span><span class="p">,</span>
<span class="linenos" data-linenos=" 3 "></span><span class="nt">&quot;timed_out&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
<span class="linenos" data-linenos=" 4 "></span><span class="nt">&quot;_shards&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="nt">&quot;total&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="nt">&quot;successful&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="nt">&quot;skipped&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="nt">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span>
<span class="linenos" data-linenos=" 9 "></span><span class="p">},</span>
<span class="linenos" data-linenos="10 "></span><span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="11 "></span>    <span class="nt">&quot;total&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="12 "></span>        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos="13 "></span>        <span class="nt">&quot;relation&quot;</span><span class="p">:</span> <span class="s2">&quot;eq&quot;</span>
<span class="linenos" data-linenos="14 "></span>    <span class="p">},</span>
<span class="linenos" data-linenos="15 "></span>    <span class="nt">&quot;max_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos="16 "></span>    <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="linenos" data-linenos="17 "></span>        <span class="p">{</span>
<span class="linenos" data-linenos="18 "></span>            <span class="nt">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;peliculas&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="19 "></span>            <span class="nt">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;_doc&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="20 "></span>            <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;FTUyU30BBEE3YF7Zlgn1&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="21 "></span>            <span class="nt">&quot;_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos="22 "></span>            <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="23 "></span>                <span class="nt">&quot;movies&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="linenos" data-linenos="24 "></span>                    <span class="p">{</span>
<span class="linenos" data-linenos="25 "></span>                        <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;The Shawshank Redemption&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="26 "></span>                        <span class="nt">&quot;rank&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="27 "></span>                        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;tt0111161&quot;</span>
<span class="linenos" data-linenos="28 "></span>                    <span class="p">},</span>
</code></pre></div>
<p>Si nos fijamos bien, realmente solo ha insertado un documento que contiene un array de películas, lo cual no está bien.</p>
<h3 id="separando-los-datos">Separando los datos<a class="headerlink" href="#separando-los-datos" title="Permanent link">&para;</a></h3>
<p>Así pues, previamente debemos separar el array contenido dentro de <code>movies.json</code> en documentos individuales.</p>
<div class="admonition warning">
<p class="admonition-title">Borrar el índice</p>
<p>Recuerda que antes de meter nuevos datos, necesitamos eliminar el índice de ElasticSearch mediante <code>curl -X DELETE "localhost:9200/peliculas"</code>.</p>
</div>
<p>Para dividir el documento de películas en documentos individuales, necesitamos utilizar el procesador <em>SplitJSON</em>. Lo conectamos entre los dos procesadores anteriores, y le indicamos en la propiedad <em>JSonPath Expression</em> la expresión donde se encuentran las películas: <code>$.movies.*</code></p>
<figure style="align: center;">
    <img src="../imagenes/etl/04caso6split.png">
    <figcaption>Separamos las películas</figcaption>
</figure>

<p>Y ahora sí volvemos a consultar el índice mediante <code>curl -X  GET "localhost:9200/peliculas/_search?pretty"</code>, sí que veremos que ha insertado las cien películas por separado:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span>  <span class="nt">&quot;took&quot;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="linenos" data-linenos=" 3 "></span>  <span class="nt">&quot;timed_out&quot;</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
<span class="linenos" data-linenos=" 4 "></span>  <span class="nt">&quot;_shards&quot;</span> <span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="nt">&quot;total&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="nt">&quot;successful&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="nt">&quot;skipped&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="nt">&quot;failed&quot;</span> <span class="p">:</span> <span class="mi">0</span>
<span class="linenos" data-linenos=" 9 "></span>  <span class="p">},</span>
<span class="linenos" data-linenos="10 "></span>  <span class="nt">&quot;hits&quot;</span> <span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="11 "></span>    <span class="nt">&quot;total&quot;</span> <span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="12 "></span>      <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
<span class="linenos" data-linenos="13 "></span>      <span class="nt">&quot;relation&quot;</span> <span class="p">:</span> <span class="s2">&quot;eq&quot;</span>
<span class="linenos" data-linenos="14 "></span>    <span class="p">},</span>
<span class="linenos" data-linenos="15 "></span>    <span class="nt">&quot;max_score&quot;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="linenos" data-linenos="16 "></span>    <span class="nt">&quot;hits&quot;</span> <span class="p">:</span> <span class="p">[</span>
<span class="linenos" data-linenos="17 "></span>      <span class="p">{</span>
<span class="linenos" data-linenos="18 "></span>        <span class="nt">&quot;_index&quot;</span> <span class="p">:</span> <span class="s2">&quot;peliculas&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="19 "></span>        <span class="nt">&quot;_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;_doc&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="20 "></span>        <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="s2">&quot;X-uaWH0BesFhA-H6MMxA&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="21 "></span>        <span class="nt">&quot;_score&quot;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="linenos" data-linenos="22 "></span>        <span class="nt">&quot;_source&quot;</span> <span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="23 "></span>          <span class="nt">&quot;title&quot;</span> <span class="p">:</span> <span class="s2">&quot;The Shawshank Redemption&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="24 "></span>          <span class="nt">&quot;rank&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="25 "></span>          <span class="nt">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;tt0111161&quot;</span>
<span class="linenos" data-linenos="26 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="27 "></span>      <span class="p">},</span>
<span class="linenos" data-linenos="28 "></span>      <span class="p">{</span>
<span class="linenos" data-linenos="29 "></span>        <span class="nt">&quot;_index&quot;</span> <span class="p">:</span> <span class="s2">&quot;peliculas&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="30 "></span>        <span class="nt">&quot;_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;_doc&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="31 "></span>        <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="s2">&quot;YOuaWH0BesFhA-H6MMxC&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="32 "></span>        <span class="nt">&quot;_score&quot;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="linenos" data-linenos="33 "></span>        <span class="nt">&quot;_source&quot;</span> <span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="34 "></span>          <span class="nt">&quot;title&quot;</span> <span class="p">:</span> <span class="s2">&quot;The Godfather&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="35 "></span>          <span class="nt">&quot;rank&quot;</span> <span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="36 "></span>          <span class="nt">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;tt0068646&quot;</span>
<span class="linenos" data-linenos="37 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="38 "></span>      <span class="p">},</span>
</code></pre></div>
<h2 id="caso-de-uso-6-de-twitter-a-elasticsearch">Caso de uso 6: de Twitter a Elasticsearch<a class="headerlink" href="#caso-de-uso-6-de-twitter-a-elasticsearch" title="Permanent link">&para;</a></h2>
<p>Para este caso de uso, vamos a recoger datos de Twitter y los vamos a meter tanto en MongoDB como en ElasticSearch a la vez.</p>
<p>El primer paso es obtener unas credenciales de desarrollador por parte de Twitter para poder acceder a su API.
Para ello, en <a href="https://developer.twitter.com/">https://developer.twitter.com/</a> creamos una cuenta de desarrollador y creamos un proyecto.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/05twitterdev.png">
    <figcaption>Claves necesarias para conectar con Twitter</figcaption>
</figure>

<h3 id="leyendo-tweets">Leyendo tweets<a class="headerlink" href="#leyendo-tweets" title="Permanent link">&para;</a></h3>
<p>Vamos a recuperar cada minuto los mensajes que contengan la palabra big data.</p>
<div class="admonition warning">
<p class="admonition-title">Procesador GetTwitter</p>
<p>En mi caso he tenido problemas de autenticación mediante el procesador <em>GetTwitter</em>. Por ello, en vez de utilizar las credenciales habituales (API Key, API Key Secret, Access Token y Access Token Secret), vamos a realizar el acceso mediante una petición HTTP utilizando un token de validación, conocido como <em>Bearer Token</em> (lo cual es una mejor práctica de seguridad).</p>
</div>
<p>Para ello, usamos un procesador <em>InvokeHTTP</em> y configuramos los siguientes parámetros:</p>
<ul>
<li>En la planificación, vamos a configurar que se realice una petición cada 100 segundos, configurando <em>Run Schedule</em> a <code>100s</code>.</li>
<li><em>HTTP Method</em>: <code>GET</code></li>
<li><em>Remote UR</em>L: <code>https://api.twitter.com/2/tweets/search/recent?query=bigdata</code><ul>
<li>Puedes comprobar todos los campos que podemos obtener de los mensajes en <a href="https://developer.twitter.com/en/docs/twitter-api/data-dictionary/object-model/tweet">https://developer.twitter.com/en/docs/twitter-api/data-dictionary/object-model/tweet</a></li>
</ul>
</li>
<li>Añadimos una propiedad que nombramos como <em>Authorization</em> y como valor la palabra <em>Bearer</em> y el token que copiamos desde la administración de Twitter: <code>Bearer AAAAAAAAAAAAAAAAAAAAAIGNWAEAAAAA...</code></li>
</ul>
<p>Tras realizar una petición, obtenemos un FF con la siguiente información (he dejado sólo dos mensajes para facilitar la visualización):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span>   <span class="nt">&quot;data&quot;</span><span class="p">:[</span>
<span class="linenos" data-linenos=" 3 "></span>      <span class="p">{</span>
<span class="linenos" data-linenos=" 4 "></span>         <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;1468197767885561856&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span>         <span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="s2">&quot;RT @CatherineAdenle: Machine Learning Algorithms in Python You Must Learn \n#DataScience #MachineLearning\n#BigData #Analytics #AI #Tech #Alg…&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span>         <span class="nt">&quot;created_at&quot;</span><span class="p">:</span><span class="s2">&quot;2021-12-07T12:36:40.000Z&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span>         <span class="nt">&quot;public_metrics&quot;</span><span class="p">:{</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="nt">&quot;retweet_count&quot;</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="nt">&quot;reply_count&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>            <span class="nt">&quot;like_count&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="linenos" data-linenos="11 "></span>            <span class="nt">&quot;quote_count&quot;</span><span class="p">:</span><span class="mi">0</span>
<span class="linenos" data-linenos="12 "></span>         <span class="p">},</span>
<span class="linenos" data-linenos="13 "></span>         <span class="nt">&quot;lang&quot;</span><span class="p">:</span><span class="s2">&quot;en&quot;</span>
<span class="linenos" data-linenos="14 "></span>      <span class="p">},</span>
<span class="linenos" data-linenos="15 "></span>      <span class="err">...</span>
<span class="linenos" data-linenos="16 "></span>      <span class="p">{</span>
<span class="linenos" data-linenos="17 "></span>         <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;1468197570925277190&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="18 "></span>         <span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="s2">&quot;RT @gp_pulipaka: A Quick Intro to Deep Learning Course! #BigData #Analytics #DataScience #AI #MachineLearning #IoT #IIoT #Python #RStats #T…&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="19 "></span>         <span class="nt">&quot;created_at&quot;</span><span class="p">:</span><span class="s2">&quot;2021-12-07T12:35:53.000Z&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="20 "></span>         <span class="nt">&quot;public_metrics&quot;</span><span class="p">:{</span>
<span class="linenos" data-linenos="21 "></span>            <span class="nt">&quot;retweet_count&quot;</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span>
<span class="linenos" data-linenos="22 "></span>            <span class="nt">&quot;reply_count&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="linenos" data-linenos="23 "></span>            <span class="nt">&quot;like_count&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="linenos" data-linenos="24 "></span>            <span class="nt">&quot;quote_count&quot;</span><span class="p">:</span><span class="mi">0</span>
<span class="linenos" data-linenos="25 "></span>         <span class="p">},</span>
<span class="linenos" data-linenos="26 "></span>         <span class="nt">&quot;lang&quot;</span><span class="p">:</span><span class="s2">&quot;en&quot;</span>
<span class="linenos" data-linenos="27 "></span>      <span class="p">}</span>
<span class="linenos" data-linenos="28 "></span>   <span class="p">],</span>
<span class="linenos" data-linenos="29 "></span>   <span class="nt">&quot;meta&quot;</span><span class="p">:{</span>
<span class="linenos" data-linenos="30 "></span>      <span class="nt">&quot;newest_id&quot;</span><span class="p">:</span><span class="s2">&quot;1468197767885561856&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="31 "></span>      <span class="nt">&quot;oldest_id&quot;</span><span class="p">:</span><span class="s2">&quot;1468197570925277190&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="32 "></span>      <span class="nt">&quot;result_count&quot;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
<span class="linenos" data-linenos="33 "></span>      <span class="nt">&quot;next_token&quot;</span><span class="p">:</span><span class="s2">&quot;b26v89c19zqg8o3fpdy8xh0ikrj9fhq1nywqt95oqkxh9&quot;</span>
<span class="linenos" data-linenos="34 "></span>   <span class="p">}</span>
<span class="linenos" data-linenos="35 "></span><span class="p">}</span>
</code></pre></div>
<p>A continuación, vamos a separar los mensajes en diferentes FF del mismo modo que acabamos de hacer en el ejercicio anterior. Así pues, añadimos el procesador <em>SplitJson</em> y configuramos la división de los mensajes mediante expresión con <code>$.data.*</code>.</p>
<h2 id="evaluando-el-idioma">Evaluando el idioma<a class="headerlink" href="#evaluando-el-idioma" title="Permanent link">&para;</a></h2>
<p>Con esta información, hemos decidido enviar todos los mensajes que vengan en inglés (<code>"lang": "en"</code>) a ElasticSearch, y los que vengan en castellano a MongoDB.</p>
<p>Mediante el procesador EvaluateJsonPath, vamos a colocar en atributos la siguiente información que queremos almacenar:</p>
<p>A continuación, conectamos con el procesador <em>RouteOnAttribute</em></p>
<h2 id="particionando-los-datos">Particionando los datos<a class="headerlink" href="#particionando-los-datos" title="Permanent link">&para;</a></h2>
<p>https://www.theninjacto.xyz/Pull-data-Twitter-push-to-Elasticsearch/</p>
<p>https://github.com/tjaensch/nifi_docker_elasticsearch_demo</p>
<p>https://medium.com/@moha.ajori/using-apache-nifi-to-load-tweets-from-twitter-api-to-memsql-19e19a3be20e</p>
<h2 id="caso-de-uso-7-kafka">Caso de uso 7: Kafka<a class="headerlink" href="#caso-de-uso-7-kafka" title="Permanent link">&para;</a></h2>
<p>Aunque Kafka lo estudiaremos en profundidad más adelante, vamos a ver como leer datos en streaming desde una <em>topic</em> para luego ingestar los datos en Elasticsearch.</p>
<p>Ejemplo con Kafka
Split Text + ExtractText + PutKafka
https://www.youtube.com/watch?v=2w14d16wR8Y</p>
<h2 id="caso-de-uso-z-twitter-kafka-mongodb">Caso de uso Z: Twitter + Kafka + MongoDB<a class="headerlink" href="#caso-de-uso-z-twitter-kafka-mongodb" title="Permanent link">&para;</a></h2>
<p>https://www.theninjacto.xyz/Data-Transformation-Pipelines-Apache-Nifi-Flink-Kafka-Cassandra-1/</p>
<div class="admonition tip">
<p class="admonition-title">Procesadores a medida</p>
</div>
<p>https://www.futurespace.es/apache-nifi-validando-transferencias-de-ficheros-caso-de-uso-real/</p>
<p>Otro ejemplo con JSON para filtrar datos
https://learning.oreilly.com/library/view/data-engineering-with/9781839214189/B15739_03_ePub_AM.xhtml#_idParaDest-45</p>
<div class="admonition info">
<p class="admonition-title">REST API</p>
<p>Nifi ofrece un API REST con el cual podemos interactuar de forma similar al interfaz gráfico.
Teniendo Nifi arrancado, prueba con las siguientes URL: <a href="https://localhost:8443/nifi-api/access">https://localhost:8443/nifi-api/access</a> y <a href="https://localhost:8443/nifi-api/flow/about">https://localhost:8443/nifi-api/flow/about</a><br />
Más información en <a href="https://nifi.apache.org/docs/nifi-docs/rest-api/index.html">https://nifi.apache.org/docs/nifi-docs/rest-api/index.html</a></p>
</div>
<h2 id="actividades">Actividades<a class="headerlink" href="#actividades" title="Permanent link">&para;</a></h2>
<p>https://github.com/addmeaning/nifi-exercises</p>
<h2 id="referencias">Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://nifi.apache.org/docs/nifi-docs/html/user-guide.html">Apache Nifi User Guide</a></li>
<li><a href="https://nifi.apache.org/docs/nifi-docs/html/nifi-in-depth.html">Apache Nifi in Depth</a></li>
<li><a href="https://www.tutorialspoint.com/apache_nifi/index.htm">Apache Nifi en TutorialsPoint</a></li>
</ul>
<p>https://www.futurespace.es/apache-nifi-flujo-de-extraccion-validacion-transformacion-y-carga-de-ficheros-caso-de-uso-real/
https://www.theninjacto.xyz/tags/apache-nifi/</p>
<!--
https://courses.cs.ut.ee/2021/cloud/spring/Main/Practice10
https://courses.cs.ut.ee/2021/cloud/spring/Main/Practice11
-->

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Volver al principio
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2021-2022 Aitor Medrano - Licencia CC BY-NC-SA
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/aitormedrano" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    <a href="mailto:<a.medrano@edu.gva.es>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM178.117 262.104C87.429 196.287 88.353 196.121 64 177.167V152c0-13.255 10.745-24 24-24h272c13.255 0 24 10.745 24 24v25.167c-24.371 18.969-23.434 19.124-114.117 84.938-10.5 7.655-31.392 26.12-45.883 25.894-14.503.218-35.367-18.227-45.883-25.895zM384 217.775V360c0 13.255-10.745 24-24 24H88c-13.255 0-24-10.745-24-24V217.775c13.958 10.794 33.329 25.236 95.303 70.214 14.162 10.341 37.975 32.145 64.694 32.01 26.887.134 51.037-22.041 64.72-32.025 61.958-44.965 81.325-59.406 95.283-70.199z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["header.autohide", "navigation.top", "navigation.tracking", "content.code.annotate"], "translations": {"clipboard.copy": "Copiar al portapapeles", "clipboard.copied": "Copiado al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.term.missing": "Falta", "select.version.title": "Seleccionar versi\u00f3n"}, "search": "../assets/javascripts/workers/search.01824240.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.ff0eccb3.min.js"></script>
      
    
  </body>
</html>