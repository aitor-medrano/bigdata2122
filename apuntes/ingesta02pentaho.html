
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://aitor-medrano.github.io/bigdata2122/apuntes/ingesta02pentaho.html">
      
      <link rel="icon" href="../imagenes/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.0.1">
    
    
      
        <title>2.- Pentaho DI - Inteligencia Artificial y Big Data</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.816931ca.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.9204c3b2.min.css">
        
          
          
          <meta name="theme-color" content="#02a6f2">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>function __md_scope(e,t,_){return new URL(_||(t===localStorage?"..":".."),location).pathname+"."+e}function __md_get(e,t=localStorage,_){return JSON.parse(t.getItem(__md_scope(e,t,_)))}function __md_set(e,t,_=localStorage,o){try{_.setItem(__md_scope(e,_,o),JSON.stringify(t))}catch(e){}}</script>
    
      

  


  

  


  <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MV889H0W63"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-MV889H0W63",{page_path:e.pathname})})})</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MV889H0W63"></script>


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="light-blue" data-md-color-accent="teal">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pentaho-data-integration" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-header__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../imagenes/logoIABD3.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inteligencia Artificial y Big Data
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2.- Pentaho DI
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-nav__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../imagenes/logoIABD3.png" alt="logo">

    </a>
    Inteligencia Artificial y Big Data
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Inicio
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" data-md-state="indeterminate" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Arquitecturas Big Data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Arquitecturas Big Data" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Arquitecturas Big Data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube01.html" class="md-nav__link">
        1.- Cloud Computing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube02aws.html" class="md-nav__link">
        2.- AWS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube03computacion.html" class="md-nav__link">
        3.- Computación
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube04almacenamiento.html" class="md-nav__link">
        4.- Almacenamiento
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube05datos.html" class="md-nav__link">
        5.- Datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="arquitecturas01.html" class="md-nav__link">
        6.- Arquitecturas
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Ingesta de Datos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ingesta de Datos" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Ingesta de Datos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="ingesta01.html" class="md-nav__link">
        1.- ETL
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          2.- Pentaho DI
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="ingesta02pentaho.html" class="md-nav__link md-nav__link--active">
        2.- Pentaho DI
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#elementos" class="md-nav__link">
    Elementos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-0" class="md-nav__link">
    Caso de Uso 0
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-1-filtrando-datos" class="md-nav__link">
    Caso de Uso 1 - Filtrando datos
  </a>
  
    <nav class="md-nav" aria-label="Caso de Uso 1 - Filtrando datos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lectura-csv" class="md-nav__link">
    Lectura CSV
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtrado-de-datos" class="md-nav__link">
    Filtrado de datos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ordenacion" class="md-nav__link">
    Ordenación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escritura-del-resultado" class="md-nav__link">
    Escritura del resultado
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uso-de-pan" class="md-nav__link">
    Uso de Pan
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-2-uniendo-datos" class="md-nav__link">
    Caso de Uso 2 - Uniendo datos
  </a>
  
    <nav class="md-nav" aria-label="Caso de Uso 2 - Uniendo datos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#merge-join" class="md-nav__link">
    Merge join
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agrupando-datos" class="md-nav__link">
    Agrupando datos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-3-cuestionarios-airbnb" class="md-nav__link">
    Caso de Uso 3 - Cuestionarios Airbnb
  </a>
  
    <nav class="md-nav" aria-label="Caso de Uso 3 - Cuestionarios Airbnb">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uniendo-datos" class="md-nav__link">
    Uniendo datos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtrado-compuesto" class="md-nav__link">
    Filtrado compuesto
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generando-json" class="md-nav__link">
    Generando JSON
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resultado-final" class="md-nav__link">
    Resultado final
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-4-informe-fabricantes-en-s3" class="md-nav__link">
    Caso de Uso 4 - Informe fabricantes en S3
  </a>
  
    <nav class="md-nav" aria-label="Caso de Uso 4 - Informe fabricantes en S3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unir-fabricantes" class="md-nav__link">
    Unir fabricantes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aplicar-formulas" class="md-nav__link">
    Aplicar fórmulas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#guardar-en-s3" class="md-nav__link">
    Guardar en S3
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-5-jobs" class="md-nav__link">
    Caso de Uso 5 - Jobs
  </a>
  
    <nav class="md-nav" aria-label="Caso de Uso 5 - Jobs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comenzando-un-job" class="md-nav__link">
    Comenzando un Job
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abortando-un-job" class="md-nav__link">
    Abortando un Job
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprobando-s3" class="md-nav__link">
    Comprobando S3
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uso-de-kitchen" class="md-nav__link">
    Uso de Kitchen
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-6-interaccion-con-bases-de-datos" class="md-nav__link">
    Caso de Uso 6 - Interacción con bases de datos
  </a>
  
    <nav class="md-nav" aria-label="Caso de Uso 6 - Interacción con bases de datos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conectando-con-la-base-de-datos" class="md-nav__link">
    Conectando con la base de datos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consultando-datos" class="md-nav__link">
    Consultando datos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insertando-datos" class="md-nav__link">
    Insertando datos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modificando-datos" class="md-nav__link">
    Modificando datos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="ingesta03nifi1.html" class="md-nav__link">
        3.- Nifi I
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="ingesta04nifi2.html" class="md-nav__link">
        4.- Nifi II
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#elementos" class="md-nav__link">
    Elementos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-0" class="md-nav__link">
    Caso de Uso 0
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-1-filtrando-datos" class="md-nav__link">
    Caso de Uso 1 - Filtrando datos
  </a>
  
    <nav class="md-nav" aria-label="Caso de Uso 1 - Filtrando datos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lectura-csv" class="md-nav__link">
    Lectura CSV
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtrado-de-datos" class="md-nav__link">
    Filtrado de datos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ordenacion" class="md-nav__link">
    Ordenación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escritura-del-resultado" class="md-nav__link">
    Escritura del resultado
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uso-de-pan" class="md-nav__link">
    Uso de Pan
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-2-uniendo-datos" class="md-nav__link">
    Caso de Uso 2 - Uniendo datos
  </a>
  
    <nav class="md-nav" aria-label="Caso de Uso 2 - Uniendo datos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#merge-join" class="md-nav__link">
    Merge join
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agrupando-datos" class="md-nav__link">
    Agrupando datos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-3-cuestionarios-airbnb" class="md-nav__link">
    Caso de Uso 3 - Cuestionarios Airbnb
  </a>
  
    <nav class="md-nav" aria-label="Caso de Uso 3 - Cuestionarios Airbnb">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uniendo-datos" class="md-nav__link">
    Uniendo datos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtrado-compuesto" class="md-nav__link">
    Filtrado compuesto
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generando-json" class="md-nav__link">
    Generando JSON
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resultado-final" class="md-nav__link">
    Resultado final
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-4-informe-fabricantes-en-s3" class="md-nav__link">
    Caso de Uso 4 - Informe fabricantes en S3
  </a>
  
    <nav class="md-nav" aria-label="Caso de Uso 4 - Informe fabricantes en S3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unir-fabricantes" class="md-nav__link">
    Unir fabricantes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aplicar-formulas" class="md-nav__link">
    Aplicar fórmulas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#guardar-en-s3" class="md-nav__link">
    Guardar en S3
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-5-jobs" class="md-nav__link">
    Caso de Uso 5 - Jobs
  </a>
  
    <nav class="md-nav" aria-label="Caso de Uso 5 - Jobs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comenzando-un-job" class="md-nav__link">
    Comenzando un Job
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abortando-un-job" class="md-nav__link">
    Abortando un Job
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprobando-s3" class="md-nav__link">
    Comprobando S3
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uso-de-kitchen" class="md-nav__link">
    Uso de Kitchen
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-6-interaccion-con-bases-de-datos" class="md-nav__link">
    Caso de Uso 6 - Interacción con bases de datos
  </a>
  
    <nav class="md-nav" aria-label="Caso de Uso 6 - Interacción con bases de datos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conectando-con-la-base-de-datos" class="md-nav__link">
    Conectando con la base de datos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consultando-datos" class="md-nav__link">
    Consultando datos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insertando-datos" class="md-nav__link">
    Insertando datos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modificando-datos" class="md-nav__link">
    Modificando datos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="pentaho-data-integration">Pentaho Data Integration<a class="headerlink" href="#pentaho-data-integration" title="Permanent link">&para;</a></h1>
<p align="right"><small>Tiempo estimado de lectura: 25 minutos [17 y 24 de Enero]</small></p>

<p><em>Kettle</em> es un componente de <em>Pentaho Data Integration</em> (PDI - <a href="https://www.hitachivantara.com/en-us/products/data-management-analytics/pentaho/download-pentaho.html">https://www.hitachivantara.com/en-us/products/data-management-analytics/pentaho/download-pentaho.html</a>) que a su vez contiene a <em>Spoon</em>. Mediante <em>Spoon</em> se pueden realizar procesos ETL de manera visual, de forma muy fácil y rápida, como por ejemplo:</p>
<ul>
<li>Conexiones a los datos.</li>
<li>Transformaciones (filtrado, limpieza, formateado, ... y posterior almacenamiento en diferentes formatos y destinos).</li>
<li>Inserción de fórmulas.</li>
<li>Desarrollo de <em>data warehouses</em> con estructura en estrella (Hechos/Dimensiones)</li>
</ul>
<p>Y todo esto sin necesidad de programar directamente con código y sin necesidad de instalar o configurar nada para poder empezar a usarla. Por esto, este tipo de herramientas se conocen como <ins>herramientas de metadatos</ins>, ya que trabajan a nivel de definición diciendo qué hay que hacer, pero no el detalle del cómo se hace, éste queda oculto, lo cual resulta muy interesante en la mayoría de los casos.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02etl.png">
    <figcaption>Pentaho - Ejemplo de flujo ETL</figcaption>
</figure>

<p>Se trata de una herramienta open source multiplataforma que también tiene su soporte comercial. La versión <em>open source</em> se puede descargar desde <a href="https://sourceforge.net/projects/pentaho/">https://sourceforge.net/projects/pentaho/</a>. En nuestro caso, vamos a trabajar con la versión 9.2 que data de agosto de 2021 (para los apuntes he trabajado indistintamente con la versión 9.1 y la 9.2, tanto en Windows como en Ubuntu).</p>
<p>Es importante destacar como requisito que necesitamos tener instalado en el sistema la versión 8 de Java.</p>
<div class="admonition tip">
<p class="admonition-title">Instalación en Ubuntu</p>
<p>Si trabajamos con Ubuntu, será necesario instalar Java 8 ejecutando el comando <code>sudo apt install openjdk-8-jdk</code>, y tras ello <code>sudo update-alternatives --config java</code> para elegir la versión 8.</p>
<p>A continuación, para instalar el paquete <em>libwebkitgtk</em>, primero tenemos que añadir su repositorio:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>sudo nano /etc/apt/sources.list
</code></pre></div>
<p>Y añadimos al final la siguiente entrada:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="k">deb</span> <span class="s">http://cz.archive.ubuntu.com/ubuntu</span> <span class="kp">bionic</span> <span class="kp">main</span> <span class="kp">universe</span>
</code></pre></div>
<p>Y tras actualizar los repositorios con <code>sudo apt-get update</code>, instalaremos el paquete con el comando:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>sudo apt-get install libwebkitgtk-1.0.0
</code></pre></div>
<p>Si ha fallado la actualización del repositorio por un problema de certificados, una posible solución es instalar <em>Y PPA Manager</em>, tal como explican <a href="https://ubunlog.com/como-arreglar-el-error-w-error-de-gpg/">aquí</a>.</p>
</div>
<p>Una vez descargado el archivo y descomprimirlo, mediante el archivo <code>spoon.bat</code> (o <code>spoon.sh</code>) lanzaremos la aplicación.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02spoon-inicio.png">
    <figcaption>Pantalla de inicio de Pentaho/Spoon</figcaption>
</figure>

<div class="admonition tip">
<p class="admonition-title">Dentro de Spoon</p>
<p><em>Spoon</em> permite diseñar mediante un interfaz gráficos las transformaciones y trabajos que se ejecutan con las siguientes herramientas:</p>
<ul>
<li><em>Pan</em> es un motor de transformación de datos que facilita la lectura, manipulación, y escritura de datos hacia y desde varias fuentes de datos. Ejecuta archivos <code>ktr</code>.</li>
<li><em>Kitchen</em> es un programa que ejecuta los trabajos (<em>jobs</em>) diseñados por Spoon en XML o en una base de datos.  Ejecuta archivos <code>kjb</code>.</li>
</ul>
</div>
<p>Para esta sesión, hemos planteado varios casos de uso para ir aprendiendo la herramienta mediante su uso.</p>
<h2 id="elementos">Elementos<a class="headerlink" href="#elementos" title="Permanent link">&para;</a></h2>
<p>En PDI hay dos tipos de elementos: <em>Transformations</em> y <em>Jobs</em>.</p>
<ul>
<li>Se definen <em>Transformations</em> para transformar los datos, describiendo flujos de datos para ETL como leer desde una fuenta, transformar los datos y cargarlos en un nuevo destino.</li>
<li>Se definen <em>Jobs</em> para organizar tareas y transformaciones estableciendo su orden y condiciones de ejecución (del tipo ¿existe el fichero X en origen? ¿existe la tabla X en mi base de datos?).</li>
</ul>
<p>Tanto las transformaciones como las tareas, cuando se definen, se almacenan como archivos.</p>
<p>Los elementos del interfaz son:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02spoon-interfaz.png">
    <figcaption>Interfaz de Spoon</figcaption>
</figure>

<h2 id="caso-de-uso-0">Caso de Uso 0<a class="headerlink" href="#caso-de-uso-0" title="Permanent link">&para;</a></h2>
<p>Para familiarizarnos con el entorno, vamos a crear una transformación muy básica. Tras seleccionar <em>File -&gt; New Transformation</em>, el primer elemento que vamos a utilizar está dentro de la categoría <em>Input</em>.</p>
<figure style="float: right;">
    <img src="../imagenes/etl/02mouseover.png">
    <figcaption>Menú emergente</figcaption>
</figure>

<p>En concreto seleccionamos la transformación <em>Get system info</em>, la cual nos permite obtener información sobre el sistema. La vamos a utilizar para averiguar la versión de PDI que estamos utilizando. Así pues, la seleccionamos desde el <em>árbol de pasos</em> y lo arrastramos a la zona de trabajo. Si dejamos el ratón sobre el elemento, nos aparecerá un menú emergente donde podremos conectar una entrada, editar las propiedades, ver el menú contextual del paso, conectar una salida e inyectar metadatos.</p>
<p>Sobre este paso, vamos a editar la información que queremos obtener. Para ello, vamos a crear una propiedad con nombre <em>Versión Pentaho</em> y seleccionaremos del desplegable la opción <em>Kettle Version</em>.</p>
<p>A continuación, en la categoría <em>Utility</em> seleccionamos el icono <em>Write to Log</em>, y lo arrastramos al area de trabajo. Ahora conectamos la salida de <em>Get system info</em> con <em>Write to log</em>, mediante la 4ª opción del menu emergente, quedando una transformación tal como se ve en la imagen:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso0.png">
    <figcaption>Caso de Uso 0 - Versión de PDI</figcaption>
</figure>

<p>Finalmente, sólo nos queda ejecutar la transformación mediante el icono del triángulo (<em>Run</em> o F9), y ver el resultado en el panel inferior.</p>
<h2 id="caso-de-uso-1-filtrando-datos">Caso de Uso 1 - Filtrando datos<a class="headerlink" href="#caso-de-uso-1-filtrando-datos" title="Permanent link">&para;</a></h2>
<p>En este caso de uso, vamos a leer un archivo CSV y vamos a filtrar los datos para quedarnos con un subconjunto de los mismos. Además, vamos a ver cómo podemos gestionar los errores y ejecutar la transformación desde el terminal.</p>
<h3 id="lectura-csv">Lectura CSV<a class="headerlink" href="#lectura-csv" title="Permanent link">&para;</a></h3>
<p>Tras crear la nueva transformación (CTRL + N), desde <em>Input</em> arrastraremos el paso de <em>CSV input file</em> para seleccionar el archivo <code>samples\transformations\files\Zipssortedbycitystate.csv</code> dentro de nuestra instalación de Pentaho.</p>
<p>Tras seleccionar el archivo, mediante el botón <em>Get Fields</em> cargaremos y comprobaremos que los campos que vamos a leer son correctos (nombre y tipo de los datos).</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02getFields.png">
    <figcaption>Caso de Uso 1 - Tras pulsar sobre Get Fields</figcaption>
</figure>

<p>Tras ello, mediante el botón <em>Preview</em> comprobaremos que los datos se leen correctamente.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02previewFields.png">
    <figcaption>Caso de Uso 1 - Resultado de la opción Preview sobre Ciudades</figcaption>
</figure>

<h3 id="filtrado-de-datos">Filtrado de datos<a class="headerlink" href="#filtrado-de-datos" title="Permanent link">&para;</a></h3>
<p>Una vez leido, el siguiente paso es filtrar las filas. Para ello, desde la categoría de <em>Flow</em>, arrastramos el paso <em>Filter</em>, y las conectamos tal como hemos realizado en el caso anterior. Al soltar la flecha, nos mostrará dos opciones:</p>
<ul>
<li><em>Main output of step</em>: define los pasos con un flujo principal, donde todo funciona bien</li>
<li><em>Error handling of step</em>: define los pasos a seguir en caso de encontrar un error</li>
</ul>
<p>De momento elegimos la primera y configuramos el filtro para solo seleccionar aquellos datos cuyo estado sea NY.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02filter.png">
    <figcaption>Caso de Uso 1 - Configuración del filtro</figcaption>
</figure>

<p>Para configurar el resultado, seleccionamos el paso del filtro, y bien pulsamos sobre el icono del ojo de la barra de herramientas, o sobre el paso, tras pulsar con el botón derecho, seleccionamos la opción <em>Preview</em>.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02previewFilter.png">
    <figcaption>Caso de Uso 1 - Resultado de hacer Preview sobre Filtro NY</figcaption>
</figure>

<p>Por defecto se precargan 1000 filas. Tras comprobar el resultado, pulsamos sobre <em>Stop</em> para detener el proceso de previsualización. Las métricas que aparecen nos información del proceso y su rendimiento.</p>
<h3 id="ordenacion">Ordenación<a class="headerlink" href="#ordenacion" title="Permanent link">&para;</a></h3>
<p>El siguiente paso que vamos a realizar es ordenar los datos por su código <em>Postal Code</em>. Para ello, desde la categoría de <em>Transform</em>, arrastramos el paso de <em>Sort rows</em>, y conectamos la salida del filtrado con la ordenación eligiendo la salida principal (<em>main output of step</em>).</p>
<div class="admonition fail">
<p class="admonition-title">Forzando un error</p>
<p>Vamos a forzar un error para comprobar cómo lo indica <em>Spoon</em>. Si al elegir el nombre del campo, en vez de <em>POSTAL CODE</em> escribimos <em>CP</em>, cuando previsualizamos el resultado, podremos ver como aparece la marca de prohibido en la esquina superior derecha del paso, y si visualizamos el log y las métricas de los pasos, veremos el error:</p>
<p><figure style="align: center;">
    <img src="../imagenes/etl/02error.png">
    <figcaption>Caso de Uso 1 - Forzando un error</figcaption>
</figure></p>
</div>
<p>Volvemos a editar el paso, corregimos el nombre del campo (escribimos <em>POSTAL CODE</em>) y comprobamos que ahora sí que funciona correctamente</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02sort.png">
    <figcaption>Caso de Uso 1 - Ordenando</figcaption>
</figure>

<h3 id="escritura-del-resultado">Escritura del resultado<a class="headerlink" href="#escritura-del-resultado" title="Permanent link">&para;</a></h3>
<p>Una vez realizados todos los pasos, sólo nos queda es enviar el resultado a un fichero para persistir la transformación.</p>
<p>Para ello, desde la categoría de <em>Output</em> arrastramos el paso <em>Text file output</em>, y lo conectamos desde la salida del paso de ordenación. Tras ello, editar este paso para indicar el archivo donde almacenar el resultado.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02textfileoutput.png">
    <figcaption>Caso de Uso 1 - Guardando el resultado</figcaption>
</figure>

<p>Tras ello, podremos ejecutar la transformación (icono del triángulo, menú <em>Action -&gt; Run</em> o F9) y comprobar el resultado en el fichero:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>CITY;STATE;POSTALCODE
<span class="linenos" data-linenos="2 "></span>HOLTSVILLE             ;NY;501
<span class="linenos" data-linenos="3 "></span>FISHERS ISLAND         ;NY;6390
<span class="linenos" data-linenos="4 "></span>NEW YORK               ;NY;10001
<span class="linenos" data-linenos="5 "></span>NEW YORK               ;NY;10003
<span class="linenos" data-linenos="6 "></span>NEW YORK               ;NY;10005
<span class="linenos" data-linenos="7 "></span>NEW YORK               ;NY;10007
<span class="linenos" data-linenos="8 "></span>NEW YORK               ;NY;10009
</code></pre></div>
<p>Al comprobar el fichero, vemos que se han quedado espacio en blanco a la derecha del nombre de las ciudades, ya que la columna tenía un tamaño configurado. Si volvemos a editar el último paso, en la pestaña de <em>Fields</em> podemos indicar mediante el botón de <em>Minimal width</em> que reduzca su anchura al mínimo:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02minimalWidth.png">
    <figcaption>Caso de Uso 1 - Anchura mínima de los campos</figcaption>
</figure>

<p>Y tras volver a ejecutar la transformación, veremos que ahora sí que obtenemos los datos que esperábamos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>CITY;STATE;POSTALCODE
<span class="linenos" data-linenos="2 "></span>HOLTSVILLE;NY;501
<span class="linenos" data-linenos="3 "></span>FISHERS ISLAND;NY;6390
<span class="linenos" data-linenos="4 "></span>NEW YORK;NY;10001
<span class="linenos" data-linenos="5 "></span>NEW YORK;NY;10003
<span class="linenos" data-linenos="6 "></span>NEW YORK;NY;10005
<span class="linenos" data-linenos="7 "></span>NEW YORK;NY;10007
<span class="linenos" data-linenos="8 "></span>NEW YORK;NY;10009
</code></pre></div>
<h3 id="uso-de-pan">Uso de Pan<a class="headerlink" href="#uso-de-pan" title="Permanent link">&para;</a></h3>
<p>Mediante la utilidad <em>Pan</em>, podemos ejecutar las transformaciones sin necesidad de arrancar <em>Spoon</em>. Para indicarle el archivo que contiene la transformación, al comando <code>pan.bat</code> (o <code>pan.sh</code> en el caso de Ubuntu) le pasamos el parámetro <code>/file=rutaArchivo.ktr</code>.</p>
<p>Para comprobar su funcionamiento, vamos a eliminar el fichero generado. A continuación, ejecutamos <code>pan</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>pan.bat /file<span class="o">=</span>c:/IABD/caso1filtradoNY.ktr
</code></pre></div>
<p>Tras algunos segundos y varias líneas de debug del arranque de pan, tendremos un mensaje similar al siguiente:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>2021/10/24 18:01:42 - Start of run.
<span class="linenos" data-linenos=" 2 "></span>2021/10/24 18:01:42 - caso1filtradoNY - Dispatching started for transformation [caso1filtradoNY]
<span class="linenos" data-linenos=" 3 "></span>2021/10/24 18:01:42 - Ciudades.0 - Header row skipped in file &#39;C:\data-integration\samples\transformations\files\Zipssortedbycitystate.csv&#39;
<span class="linenos" data-linenos=" 4 "></span>2021/10/24 18:01:42 - Ciudades.0 - Finished processing (I=21380, O=0, R=0, W=21379, U=0, E=0)
<span class="linenos" data-linenos=" 5 "></span>2021/10/24 18:01:42 - Filtro NY.0 - Finished processing (I=0, O=0, R=21379, W=1146, U=0, E=0)
<span class="linenos" data-linenos=" 6 "></span>2021/10/24 18:01:42 - Orden por Codigo Postal.0 - Finished processing (I=0, O=0, R=1146, W=1146, U=0, E=0)
<span class="linenos" data-linenos=" 7 "></span>2021/10/24 18:01:42 - CiudadesNY.0 - Finished processing (I=0, O=1147, R=1146, W=1146, U=0, E=0)
<span class="linenos" data-linenos=" 8 "></span>2021/10/24 18:01:43 - Carte - Installing timer to purge stale objects after 1440 minutes.
<span class="linenos" data-linenos=" 9 "></span>2021/10/24 18:01:43 - Finished!
<span class="linenos" data-linenos="10 "></span>2021/10/24 18:01:43 - Start=2021/10/24 18:01:42.424, Stop=2021/10/24 18:01:43.041
<span class="linenos" data-linenos="11 "></span>2021/10/24 18:01:43 - Processing ended after 0 seconds.
<span class="linenos" data-linenos="12 "></span>2021/10/24 18:01:43 - caso1filtradoNY -
<span class="linenos" data-linenos="13 "></span>2021/10/24 18:01:43 - caso1filtradoNY - Step Ciudades.0 ended successfully, processed 21379 lines. ( - lines/s)
<span class="linenos" data-linenos="14 "></span>2021/10/24 18:01:43 - caso1filtradoNY - Step Filtro NY.0 ended successfully, processed 21379 lines. ( - lines/s)
<span class="linenos" data-linenos="15 "></span>2021/10/24 18:01:43 - caso1filtradoNY - Step Orden por Codigo Postal.0 ended successfully, processed 1146 lines. ( - lines/s)
<span class="linenos" data-linenos="16 "></span>2021/10/24 18:01:43 - caso1filtradoNY - Step CiudadesNY.0 ended successfully, processed 1146 lines. ( - lines/s)
</code></pre></div>
<p>Y si comprobamos el fichero, veremos que ha vuelto a aparecer.</p>
<h2 id="caso-de-uso-2-uniendo-datos">Caso de Uso 2 - Uniendo datos<a class="headerlink" href="#caso-de-uso-2-uniendo-datos" title="Permanent link">&para;</a></h2>
<figure style="float: right;">
    <img src="../imagenes/etl/02caso2paso1.png">
    <figcaption>Caso de Uso 2 - Lecturas CSV</figcaption>
</figure>

<p>En este caso, vamos a leer datos de <a href="../recursos/pdi_sales.csv">ventas</a> y de <a href="../recursos/pdi_product.csv">productos</a>, y vamos a unirlos de forma similar a un <em>join</em>, para posteriormente, tras agrupar los datos, crear un informe.</p>
<h3 id="merge-join"><em>Merge join</em><a class="headerlink" href="#merge-join" title="Permanent link">&para;</a></h3>
<p>Para ello, primero vamos leer de forma separada cada archivo mediante un paso de tipo <em>CSV file input</em>, utilizando el <code>;</code> como separado. Así pues, tendremos dos pasos, tal como se puede observar en la imagen de la derecha. En el caso del CSV de Ventas, al tener ventas de diferentes paises, deberemos cambiar el tipo del ZIP (el código postal) a <code>String</code>.</p>
<p>A continuación, para unir los datos, dentro de la categoría <em>Join</em> utilizamos el paso <em>Merge join</em>. En este caso tras arrastrar el paso al área de trabajo, vamos a enlazar desde el merge hacia los dos orígenes, en un caso como <em>left hand side stream of the join</em> y el otro fomo <em>right hand side stream of the join</em>:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso2merge.png">
    <figcaption>Caso de Uso 2 - Entradas de Merge</figcaption>
</figure>

<p>A continuación, editamos el <em>Merge</em> y le decimos que el campo de unión es <em>ProductID</em>. Cuando le damos a aceptar recibimos un mensaje de advertencia avisándonos que si los datos no están ordenados podemos obtener resultados incorrectos.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso2mensajeMerge.png">
    <figcaption>Caso de Uso 2 - Aviso Merge</figcaption>
</figure>

<p>Así pues, vamos a añadir previo al merge un paso de ordenación a cada entrada, ordenando los datos por <em>ProductID</em> de manera ascendente. Para comprobar su funcionamiento, podemos hacer un <em>preview</em> del <em>merge</em>.</p>
<h3 id="agrupando-datos">Agrupando datos<a class="headerlink" href="#agrupando-datos" title="Permanent link">&para;</a></h3>
<p>Como el resultado final es un informe de ventas con el total de unidades vendidas y la cantidad recaudada agrupada por pais y categoría del producto, necesitamos agrupar los datos.</p>
<p>Para ello, dentro de la categoría <em>Statistics</em>, utilizaremos el paso <em>Group by</em>. En nuestro caso queremos agrupar por país (<em>Country</em>) y categoría (<em>Category</em>), y los datos que vamos a agregar son la suma de unidades (<em>Units</em>) y la suma recaudada (<em>Revenue</em>). Así pues, nuestra agrupación quedaría así:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso2groupby.png">
    <figcaption>Caso de Uso 2 - Agrupamos por país y categoría</figcaption>
</figure>

<p>En este caso, sucede lo mismo que antes, que este paso necesita los datos ordenados. Así pues, vamos a ordenar las salida del merge por país y categoría.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso2ordenPreGroupby.png">
    <figcaption>Caso de Uso 2 - Ordenamos antes de agrupar</figcaption>
</figure>

<p>El último paso que nos queda es exportar los datos a un fichero de texto mediante el paso <em>Text file output</em>. </p>
<h2 id="caso-de-uso-3-cuestionarios-airbnb">Caso de Uso 3 - Cuestionarios Airbnb<a class="headerlink" href="#caso-de-uso-3-cuestionarios-airbnb" title="Permanent link">&para;</a></h2>
<p>Para el siguiente caso de uso, vamos a utilizar datos de los cuestionarios de AirBnb que se pueden descargar desde <a href="http://tomslee.net/airbnb-data-collection-get-the-data">http://tomslee.net/airbnb-data-collection-get-the-data</a>.</p>
<p>En concreto, nos vamos a centrar en los datos de Madrid que podemos descargar desde <a href="https://s3.amazonaws.com/tomslee-airbnb-data-2/madrid.zip">https://s3.amazonaws.com/tomslee-airbnb-data-2/madrid.zip</a>.</p>
<h3 id="uniendo-datos">Uniendo datos<a class="headerlink" href="#uniendo-datos" title="Permanent link">&para;</a></h3>
<p>Una vez descargados los datos y descomprimidos, vamos a cargar los tres ficheros en el mismo paso, utilizando dentro de <em>Input</em> la opción de <em>Text File Input</em>:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02lecturaMultiples.png">
    <figcaption>Caso de Uso 3 - Filtrado compuesto</figcaption>
</figure>

<p>Recordad que antes, en la pestaña <em>Fields</em>, tenemos que obtener los campos a leer.</p>
<p>Nos vamos a quedar con un subconjunto de las columnas y las vamos a renombrar. Para ello, dentro de la categoría <em>Transform</em> elegimos el paso <em>Select values</em> y elegimos y renombramos los siguentes campos:</p>
<ul>
<li><code>room_id</code>, <code>room_type</code>, <code>neighborhood</code>, <code>bedrooms</code>, <code>overall_satisfaction</code>, <code>accommodates</code>, y <code>price</code> pasarán a ser
<code>habitacion_id</code>, <code>habitacion_tipo</code>, <code>barrio</code>, <code>dormitorios</code>, <code>puntuacion</code>, <code>huespedes</code> y <code>precio</code>.</li>
</ul>
<figure style="align: center;">
    <img src="../imagenes/etl/02seleccionRenombrado.png">
    <figcaption>Caso de Uso 3 - Selección y nombrado de campos</figcaption>
</figure>

<h3 id="filtrado-compuesto">Filtrado compuesto<a class="headerlink" href="#filtrado-compuesto" title="Permanent link">&para;</a></h3>
<p>El siguiente paso que vamos a hacer es quedarnos con aquellos cuestionarios con más de 3 dormitorios o al menos 4 huéspedes. Así pues, con el paso <em>Filter Rows</em> realizaremos:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02filterCompuesto.png">
    <figcaption>Caso de Uso 3 - Filtrado compuesto</figcaption>
</figure>

<p>Si el filtrado fuese con condiciones más complejas, en ocasiones es más sencillo utilizar el paso <em>Java filter</em> (de la categoría <em>Flow</em>), el cual utilizando la notación de Java, podemos indicar la condición a cumplir. Por ejemplo, vamos filtrar los de más de 3 dormitorios o al menos 4 huéspedes, y que su precio sea inferior a 200$:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02filterJava.png">
    <figcaption>Caso de Uso 3 - Filtrado Java</figcaption>
</figure>

<p>Para comprobar su funcionamiento, vamos a añadir un par de pasos <em>dummy</em> (no realizan nada, pero sirven para finalizar tareas). Al ejecutarlo, veremos que nos da un error. Si algún dato es nulo, el filtrado Java provocará un error de transformación.</p>
<p>Una posibilidad es que introduzcamos un paso de la categoría <em>Utility</em> denominado <em>If value is null</em>. Coneste paso, podemos indicar el valor a tomar a todos los campos o hacerlo de forma concreta en los campos que queramos. En nuestro caso, vamos indicar que cambie todos los nulos por <code>-1</code>.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02ifnull.png">
    <figcaption>Caso de Uso 3 - Cambiando nulos por -1</figcaption>
</figure>

<p>Debemos tener en cuenta que como ahora podemos tener precios con -1, para evitar recogerlos en el filtrado Java, deberíamos modificarlo por <code>(dormitorios &gt; 3 || huespedes &gt;=4) &amp;&amp; ( precio &gt;= 0 &amp;&amp; precio &lt; 200)</code>.</p>
<h3 id="generando-json">Generando JSON<a class="headerlink" href="#generando-json" title="Permanent link">&para;</a></h3>
<figure style="float: right;">
    <img src="../imagenes/etl/02JSONoutput.png" width="350">
    <figcaption>Caso de Uso 3 - Configuración JSON</figcaption>
</figure>

<p>Finalmente queremos almacenar los datos que cumplen el filtro en un fichero JSON.</p>
<p>Para ello, sustituimos el <em>dummy</em> del camino exitoso por un paso <em>JSON output</em>, configurando:</p>
<ul>
<li><em>Filename</em>: La ruta y el nombre del archivo</li>
<li><em>Json bloc name</em>: nombre de la propiedad que contendrá un objeto o un array de objetos con los datos.</li>
<li><em>Nr rows in a bloc</em>: Cantidad de datos del archivo. Si ponemos 0, coloca todos los datos en el mismo fichero. Si ponemos 1, generará un fichero por cada registro.</li>
</ul>
<p>En la imagen que tenemos a la derecha puedes comprobar los valores introducidos.</p>
<h3 id="resultado-final">Resultado final<a class="headerlink" href="#resultado-final" title="Permanent link">&para;</a></h3>
<p>En la siguiente imagen puedes comprobar la transformación completa:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso3.png">
    <figcaption>Caso de Uso 3 - Transformación final</figcaption>
</figure>

<p>La cual, al ejecutarla, genera los siguientes datos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="nt">&quot;datos&quot;</span><span class="p">:[</span>
<span class="linenos" data-linenos="2 "></span>    <span class="p">{</span><span class="nt">&quot;dormitorios&quot;</span><span class="p">:</span><span class="mf">4.0</span><span class="p">,</span> <span class="nt">&quot;huespedes&quot;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="nt">&quot;barrio&quot;</span><span class="p">:</span><span class="s2">&quot;Argüelles&quot;</span><span class="p">,</span> <span class="nt">&quot;precio&quot;</span><span class="p">:</span><span class="mf">133.0</span><span class="p">,</span> <span class="nt">&quot;habitacion_tipo&quot;</span><span class="p">:</span><span class="s2">&quot;Entire home\/apt&quot;</span><span class="p">,</span><span class="nt">&quot;puntuacion&quot;</span><span class="p">:</span><span class="mf">4.0</span><span class="p">,</span> <span class="nt">&quot;habitacion_id&quot;</span><span class="p">:</span><span class="mi">23021</span><span class="p">},</span>
<span class="linenos" data-linenos="3 "></span>    <span class="p">{</span><span class="nt">&quot;dormitorios&quot;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="nt">&quot;huespedes&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="nt">&quot;barrio&quot;</span><span class="p">:</span><span class="s2">&quot;Justicia&quot;</span><span class="p">,</span> <span class="nt">&quot;precio&quot;</span><span class="p">:</span><span class="mf">147.0</span><span class="p">,</span> <span class="nt">&quot;habitacion_tipo&quot;</span><span class="p">:</span><span class="s2">&quot;Private room&quot;</span><span class="p">,</span><span class="nt">&quot;puntuacion&quot;</span><span class="p">:</span><span class="mf">5.0</span><span class="p">,</span><span class="nt">&quot;habitacion_id&quot;</span><span class="p">:</span><span class="mi">24836</span><span class="p">},</span>
<span class="linenos" data-linenos="4 "></span>    <span class="p">{</span><span class="nt">&quot;dormitorios&quot;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="nt">&quot;huespedes&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="nt">&quot;barrio&quot;</span><span class="p">:</span><span class="s2">&quot;Bellas Vistas&quot;</span><span class="p">,</span> <span class="nt">&quot;precio&quot;</span><span class="p">:</span><span class="mf">44.0</span><span class="p">,</span> <span class="nt">&quot;habitacion_tipo&quot;</span><span class="p">:</span><span class="s2">&quot;Private room&quot;</span><span class="p">,</span><span class="nt">&quot;puntuacion&quot;</span><span class="p">:</span><span class="mf">4.0</span><span class="p">,</span> <span class="nt">&quot;habitacion_id&quot;</span><span class="p">:</span><span class="mi">34801</span><span class="p">},</span>
<span class="linenos" data-linenos="5 "></span>    <span class="err">...</span>
<span class="linenos" data-linenos="6 "></span>    <span class="p">]</span>
<span class="linenos" data-linenos="7 "></span><span class="p">}</span>
</code></pre></div>
<h2 id="caso-de-uso-4-informe-fabricantes-en-s3">Caso de Uso 4 - Informe fabricantes en S3<a class="headerlink" href="#caso-de-uso-4-informe-fabricantes-en-s3" title="Permanent link">&para;</a></h2>
<p>A partir del caso 2, ahora vamos a generar un informe sobre ventas de los fabricantes, y vamos a guardar el informe en S3.</p>
<h3 id="unir-fabricantes">Unir fabricantes<a class="headerlink" href="#unir-fabricantes" title="Permanent link">&para;</a></h3>
<p>Así pues, vamos a abrir el caso de uso 2, y a partir de ahí, vamos a fusionar los datos con los de <a href="../recursos/pdi_manufacturer.csv">fabricantes</a> para obtener el nombre de éstos. Para ello, creamos una nueva lectura de CSV, ordenación y posterior <em>Merge</em>. Cabe destacar que antes de hacer el segundo <em>join</em>, debemos ordenar ambas entradas por la clave de unión (<code>ManufacturerID</code>):</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso4mergeFabricantes.png">
    <figcaption>Caso de Uso 4 - Merge fabricantes</figcaption>
</figure>

<h3 id="aplicar-formulas">Aplicar fórmulas<a class="headerlink" href="#aplicar-formulas" title="Permanent link">&para;</a></h3>
<p>Tras unir los datos de las ventas con los fabricantes, para poder preparar el informe mediante group-by, del mismo modo que antes, necesitamos ordenar los datos (en este caso por <code>ManufacturerID</code>).</p>
<p>En el informe queremos mostrar para cada fabricante, además de su código y nombre (campos de agrupación), queremos obtener el total de unidades vendidad y la recaudación total de dicho fabricante. Para ello creamos una nueva agrupación.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso4groupByFabricante.png">
    <figcaption>Caso de Uso 4 - Agrupamos por fabricante</figcaption>
</figure>

<p>Además, queremos que nos muestre un nuevo campo que muestre el precio medio obtenido de dividir la recaudación obtenida entre el total de unidades. Para ello, dentro de la categoría <em>Transform</em>, elegimos el paso <em>Calculator</em>.
Una vez abierto el diálogo para editar el paso, si desplegamos la columna <em>Calculation</em> puedes observar todas las posibles operaciones y transformaciones (tanto númericas, como de campos de texto e incluso fecha) que podemos realizar. En nuestro caso, sólo necesitamos la división entre <em>A</em> y <em>B</em>:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso4calculator.png">
    <figcaption>Caso de Uso 4 - Fórmula entre dos campos</figcaption>
</figure>

<h3 id="guardar-en-s3">Guardar en S3<a class="headerlink" href="#guardar-en-s3" title="Permanent link">&para;</a></h3>
<p>Para almacenar los datos en S3, primero crearemos un <em>bucket</em> público (en mi caso lo he denominado <code>severo2122pdi</code>) y para facilitar el trabajo, vamos a crear una política que permita todas las operaciones:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="nt">&quot;Id&quot;</span><span class="p">:</span> <span class="s2">&quot;Policy1635323698048&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 4 "></span>    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="linenos" data-linenos=" 5 "></span>        <span class="p">{</span>
<span class="linenos" data-linenos=" 6 "></span>            <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;Stmt1635323796449&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span>            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="nt">&quot;Principal&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;s3:*&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:s3:::severo2122pdi&quot;</span>
<span class="linenos" data-linenos="11 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="12 "></span>    <span class="p">]</span>
<span class="linenos" data-linenos="13 "></span><span class="p">}</span>
</code></pre></div>
<p>El siguente paso es configurar las credenciales de acceso en nuestro sistema. Recuerda que lo haremos mediante las variables de entorno (<code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code> y <code>AWS_SESSION_TOKEN</code>) o almacenando las credenciales en el archivo <code>%UserProfile%\.aws\credentials</code>.</p>
<p>Finalmente, añadimos el paso <em>S3 file output</em> indicando:</p>
<ul>
<li>La ruta del archivo, la cual se forma de forma similar a <code>s3n://s3n/bucket/nombreArchivo</code>. En nuestro caso, hemos utilizado el nombre <code>s3n://s3n/severo2122pdi/informeFabricantes</code>.</li>
<li>y la extensión: nosotros hemos elegido el formato <em>csv</em></li>
</ul>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso4s3output.png">
    <figcaption>Caso de Uso 4 - Salida a S3</figcaption>
</figure>

<p>Una vez todo unido, tras ejecutarlo podremos acceder a nuestra consola de AWS y comprobar como ha aparecido el fichero.</p>
<p>En resumen, en este caso de uso hemos utilizado la siguiente transformación:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso4final.png">
    <figcaption>Caso de Uso 4 - Resultado final</figcaption>
</figure>

<h2 id="caso-de-uso-5-jobs">Caso de Uso 5 - Jobs<a class="headerlink" href="#caso-de-uso-5-jobs" title="Permanent link">&para;</a></h2>
<p>En este caso de uso vamos a crear un <em>Job</em> que nos permita coordinar los casos de uso 2 y 4 mediante un solo proceso.</p>
<p>Para ello, primero creamos el Job desde <em>File -&gt; New -&gt; Job</em>.
Si vamos a la pestaña <em>Design</em> podemos observar cómo aparecen nuevos elementos con los que diseñar los trabajos.</p>
<h3 id="comenzando-un-job">Comenzando un Job<a class="headerlink" href="#comenzando-un-job" title="Permanent link">&para;</a></h3>
<figure style="float: right;">
    <img src="../imagenes/etl/02job1.png">
    <figcaption>Caso de Uso 5 - Inicio</figcaption>
</figure>

<p>El primer componente a incorporar será <em>Start</em> (se encuentra dentro de la categoría <em>General</em>) que dará origen a nuestro flujo de datos. El siguiente componente será <em>File exists</em> (categoría <em>Conditions</em>) que buscará en el directorio donde guardamos el resultado del caso de uso 2 con el informe de ventas.</p>
<p>A continuación, añadimos un componente <em>Delete Files</em>, para que en el caso de que el fichero exista lo borremos. Además, añadimos un elemento <em>Display msgbox info</em> para avisarnos de que ha borrado el fichero de ventas que existía anteriormente.</p>
<p>A continuación, añadimos nuestra transformación del caso de uso 2 a través del elemento <em>Transformation</em>. Finalmente, unimos tanto la salida del <em>Display msgbox info</em> como la de <em>File exists</em> con nuestra transformación.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02job2.png">
    <figcaption>Caso de Uso 5 - ejecución transformación caso de uso 2</figcaption>
</figure>

<h3 id="abortando-un-job">Abortando un Job<a class="headerlink" href="#abortando-un-job" title="Permanent link">&para;</a></h3>
<p>En este momento, ya tenemos el informe de ventas y queremos generar el informe de fabricantes (caso de uso 4).</p>
<p>Antes de comenzar con el caso 4, vamos a comprobar que la tranformación anterior ha generado el fichero que esperábamos mediante el componente <em>File exists</em>. En el caso de que no lo haga, vamos a abortar el job mediante el componente <em>Abort job</em>.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02job3.png">
    <figcaption>Caso de Uso 5 - Detención de un job</figcaption>
</figure>

<h3 id="comprobando-s3">Comprobando S3<a class="headerlink" href="#comprobando-s3" title="Permanent link">&para;</a></h3>
<p>A continuación repetimos los pasos que hemos hecho al principio de este job pero en este caso comprobando si existe el fichero en S3, y si lo está operamos igual, lo borramos y volvemos a ejecutar la transformación.</p>
<p>Para comprobar que el fichero existe en S3, con el mismo componente, en la parte superior elegimos S3, y a partir de ahí ponemos la URL de nuestro <em>bucket</em> donde estarán nuestros archivos CSV:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02job4compruebaS3.png">
    <figcaption>Caso de Uso 5 - Comprobando S3</figcaption>
</figure>

<p>El resultado final debería ser similar al siguiente gráfico:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02job5.png">
    <figcaption>Caso de Uso 5 - Resultado final</figcaption>
</figure>

<h3 id="uso-de-kitchen">Uso de Kitchen<a class="headerlink" href="#uso-de-kitchen" title="Permanent link">&para;</a></h3>
<p>Igual que <a href="#uso-de-pan">Pan</a> nos permite ejecutar transformaciones desde un terminal, mediante Kitchen podemos ejecutar <em>jobs</em>.</p>
<p>Así pues, si nuestro caso de uso lo hemos almacenado en el archivo <code>caso5Job.kjb</code>, lo ejecutaríamos así:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>kitchen.sh /file<span class="o">=</span>caso5Job.kjb
</code></pre></div>
<p>Tanto a <em>Pan</em> como a <em>Kitchen</em> les podemos pasar más parámetros:</p>
<ul>
<li><code>level</code>: Indica el nivel del log, utilizando la sintaxis <code>/level:&lt;nivel&gt;</code>, siendo los posibles niveles <code>Nothing</code>, <code>Minimal</code>, <code>Error</code>, <code>Basic</code>, <code>Detailed</code>, <code>Debug</code>, y <code>Rowlevel</code>.</li>
<li><code>param</code>: permite pasar parámetros al <em>job</em>. Se indica uno por cada parámetro a pasar, y la sintaxis es <code>/param:"&lt;nombre&gt;=&lt;valor&gt;"</code>.</li>
</ul>
<h2 id="caso-de-uso-6-interaccion-con-bases-de-datos">Caso de Uso 6 - Interacción con bases de datos<a class="headerlink" href="#caso-de-uso-6-interaccion-con-bases-de-datos" title="Permanent link">&para;</a></h2>
<p>En este ejemplo vamos a interactuar con una base de datos relacional. En nuestro caso lo hemos planteado con Amazon RDS (si la quieres realizar en local, funcionará igualmente).</p>
<p>Para ello, en RDS creamos una base de datos que vamos a llamar <em>sports</em> (podéis seguir los pasos del <a href="nube05datos.html#ejemplo-rds">ejemplo de RDS</a> para crear la base de datos). Los datos están disponibles en <a href="http://www.sportsdb.org/sd/samples">http://www.sportsdb.org/sd/samples</a> o los podéis descargar directamente desde <a href="../recursos/sportsdb_mysql.sql">aquí</a>.</p>
<h3 id="conectando-con-la-base-de-datos">Conectando con la base de datos<a class="headerlink" href="#conectando-con-la-base-de-datos" title="Permanent link">&para;</a></h3>
<p>Antes de empezar a crear nuestra transformación, hemos de configurar la conexión a la base de datos recién creada. Antes de nada hemos de instalar el driver JDBC para conectar con <em>MySQL</em> (por defecto, únicamente está instalado el driver de <em>PostgreSQL</em>). Para ello, una vez <a href="../recursos/mysql-connector-java-5.1.49-bin.jar">descargado</a> (cuidado que no funciona con la última versión del driver JDBC), copiar el <em>jar</em> dentro de la carpeta <em>lib</em> de nuestra instalación de <em>Pentaho</em>.</p>
<p>Finalmente, mediante <em>File</em> -&gt; <em>New</em> -&gt; <em>Database connection</em>, usaremos el asistente para crear la conexión con la base de datos que hemos importado en RDS.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso6db.png">
    <figcaption>Caso de Uso 6 - Conexión con RDS</figcaption>
</figure>

<p>Para cargar los datos tenemos varias opciones (nosotros hemos utilizado el usuario <code>admin</code>/<code>adminadmin</code>):</p>
<ol>
<li>Desde una herramienta visual como <a href="https://dbeaver.io/">DBeaver</a>.</li>
<li>Desde el terminal:
    <div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>mysql -h sports.cm4za4bbxb45.us-east-1.rds.amazonaws.com -u admin -p sports &lt; sportsdb_mysql.sql
</code></pre></div></li>
<li>Creando una instancia EC2, subiendo los datos a la instancia y luego conectarnos desde el terminal (este es el proceso que realiza la carga de datos más eficiente, ya que colocamos la instancia de EC2 en la misma AZ que la de RDS). Más información en <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/MySQL.Procedural.Importing.NonRDSRepl.html">https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/MySQL.Procedural.Importing.NonRDSRepl.html</a></li>
</ol>
<h3 id="consultando-datos">Consultando datos<a class="headerlink" href="#consultando-datos" title="Permanent link">&para;</a></h3>
<p>Vamos a partir de un archivo <a href="../recursos/injuries.txt">injuries.txt</a> con formato CSV que contiene información sobre las lesiones  que tienen los diferentes deportistas. Podemos ver extracto del archivo a continuación:</p>
<div class="highlight"><span class="filename">injuries.txt</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span>person_id;injury_type;injury_date
<span class="linenos" data-linenos="2 "></span>153;elbow;2007-07-09
<span class="linenos" data-linenos="3 "></span>186;fingers;2007-07-15
<span class="linenos" data-linenos="4 "></span>198;shoulder;2007-07-15
<span class="linenos" data-linenos="5 "></span>213;elbow;2007-07-16
</code></pre></div>
<p>Así pues, tenemos las claves primarias de los deportistas y las lesiones. Por lo tanto, vamos a comenzar nuestra transformación leyendo dicho archivo mediante un <em>CSV input file</em>.</p>
<p>Si comprobamos en la base de datos, la tabla <code>display_names</code>, además de los nombres de las personas, tiene un campo <code>entity_type</code> con el valor <code>persons</code>.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso6display_names.png">
    <figcaption>Caso de Uso 6 - Datos de la tabla display_names</figcaption>
</figure>

<p>Para que al buscar los valores en la tabla obtengamos los nombres de las personas, necesitamos añadirle dicha constante a nuestro flujo de datos.</p>
<p>Para ello, dentro de la categoría <em>Transform</em>, añadimos un paso de tipo <em>Constant</em> y añadimos la propiedad <code>type_persons</code> con el valor <code>persons</code>:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso6addConstant.png">
    <figcaption>Caso de Uso 6 - Añadimos constante persons</figcaption>
</figure>

<p>Para obtener el nombre de y resto de datos, vamos a acceder a la base de datos utilizando el componente <em>Database lookup</em> el cual configuraremos tal como podemos ver en la imagen:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso6lookup.png">
    <figcaption>Caso de Uso 6 - Lookup del nombre</figcaption>
</figure>

<p>Y si hacemos preview de los datos, veremos que ya tenemos los nombre de los deportistas que han sufrido alguna lesión.</p>
<div class="admonition caution">
<p class="admonition-title">Usuario no encontrado</p>
<p>Si en nuestro archivo de texto tenemos un <code>person_id</code> que no aparece en la base de datos, los campos que recuperarán de la base de datos aparecerán como nulos.
Si no queremos este comportamiento, hemos de marcar la casilla <em>Do not pass the row if the lookup fails</em>.</p>
</div>
<h3 id="insertando-datos">Insertando datos<a class="headerlink" href="#insertando-datos" title="Permanent link">&para;</a></h3>
<p>Otro caso muy común al trabajar con bases de datos, es tener que insertar datos. Así pues, vamos a partir del mismo fichero de texto con las lesiones, y vamos a insertar los datos en la tabla <code>injury_phases</code>.</p>
<p>Vamos a suponer que las lesiones que tenemos en el fichero de texto finalizan cuando ejecutamos la transformación. Así pues, vamos a tener que añadir al flujo de datos la fecha del sistema.</p>
<p>Para ello, mediante el paso <em>Get System Info</em> creamos un campo que hemos llamado <code>sysdate</code> con la fecha del sistema.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso6sysdate.png">
    <figcaption>Caso de Uso 6 - Obteniendo la fecha del sistema</figcaption>
</figure>

<p>A continuación, a este paso, le añadimos desde la categoría <em>Output</em>  un paso de tipo <em>Table output</em> donde además de indicar la tabla, mapeamos los campos (con ayuda del botón <em>Get fields</em>) de nuestro flujo de datos con las columnas de la tabla <code>injury_phases</code> de la base de datos:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso6insert.png">
    <figcaption>Caso de Uso 6 - Insertando datos</figcaption>
</figure>

<p>Una vez ejecutada la transformación, podemos comprobar que se han insertado, por ejemplo, utilizando la siguiente consulta:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="k">SELECT</span> <span class="o">*</span>
<span class="linenos" data-linenos="2 "></span><span class="k">FROM</span> <span class="n">injury_phases</span>
<span class="linenos" data-linenos="3 "></span><span class="k">WHERE</span> <span class="n">end_date_time</span> <span class="o">&gt;</span> <span class="s1">&#39;2021-01-01&#39;</span>
</code></pre></div>
<h3 id="modificando-datos">Modificando datos<a class="headerlink" href="#modificando-datos" title="Permanent link">&para;</a></h3>
<p>A continuación, vamos a modificar los datos almacenados en la tabla de lesiones a partir de otro archivo <a href="../recursos/injuries2.txt">injuries2.txt</a> el cual, además de los datos anteriores, nos indica el lugar de la lesión y un campo de comentarios:</p>
<div class="highlight"><span class="filename">injuries2.txt</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span>person_id;injury_type;injury_side;injury_date;comment
<span class="linenos" data-linenos="2 "></span>153;elbow;left;2007-07-09;temporada 2018
<span class="linenos" data-linenos="3 "></span>198;shoulder;left;2007-07-15;jugando al futbol
<span class="linenos" data-linenos="4 "></span>2523;knee;;2007-07-31;ligamento cruzado anterior
<span class="linenos" data-linenos="5 "></span>9999;other-excused;;2021-01-06;jugando a la consola
</code></pre></div>
<p>En aquellos casos que la lesión que leamos del fichero ya exista, queremos actualizar la información de la base de datos con los datos del fichero.</p>
<p>Para ello, creamos una nueva transformación y leemos el fichero mediante un <em>CSV input file</em>. A continuación, añadimos un paso <em>Update</em> de la categoría <em>Output</em> (en la imagen podéis observar como hemos mapeado los campos de búsqueda y los de actualización) y finalizamos con un paso de <em>Write to Log</em> enlazando los posibles errores que podamos encontrar:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso6update.png">
    <figcaption>Caso de Uso 6 - Modificando datos</figcaption>
</figure>

<p>Una vez ejecutada, si comprobáis el log, podemos observar como el último registro no se ha procesado correctamente(En el mensaje <em>Finished processing (I=4, O=0, R=4, W=3, U=0, E=1)</em> el valor de <code>E=1</code> indica la cantidad de errores).</p>
<p>Para mejorar el mensaje de error, vamos a hacer botón derecho sobre el paso <em>Actualiza lesiones</em>  y seleccionamos la opción de <em>Error Handling....</em> y añadimos los valores a los campos <em>Error description fieldname</em> y <em>Error fields fieldname</em>:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/02caso6errores.png">
    <figcaption>Caso de Uso 6 - Configurando mensajes de error</figcaption>
</figure>

<p>Lo que provocaría que al volver a ejectuar la transformación, ya podamos obtener información del motivo del error:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>2021/11/11 12:44:40 - Write to log.0 - 
<span class="linenos" data-linenos=" 2 "></span>2021/11/11 12:44:40 - Write to log.0 - ------------&gt; Linenr 1------------------------------
<span class="linenos" data-linenos=" 3 "></span>2021/11/11 12:44:40 - Write to log.0 - person_id = 9999
<span class="linenos" data-linenos=" 4 "></span>2021/11/11 12:44:40 - Write to log.0 - injury_type = other-excused
<span class="linenos" data-linenos=" 5 "></span>2021/11/11 12:44:40 - Write to log.0 - injury_side = null
<span class="linenos" data-linenos=" 6 "></span>2021/11/11 12:44:40 - Write to log.0 - injury_date = 2021-01-06
<span class="linenos" data-linenos=" 7 "></span>2021/11/11 12:44:40 - Write to log.0 - comment = jugando a la consola
<span class="linenos" data-linenos=" 8 "></span>2021/11/11 12:44:40 - Write to log.0 - cantidad_errores = 1
<span class="linenos" data-linenos=" 9 "></span>2021/11/11 12:44:40 - Write to log.0 - msj_error = Entry to update with following key could not be found: [9999], [2021-01-06]
<span class="linenos" data-linenos="10 "></span>2021/11/11 12:44:40 - Write to log.0 - campos_error = person_id, injury_date
<span class="linenos" data-linenos="11 "></span>2021/11/11 12:44:40 - Write to log.0 - 
<span class="linenos" data-linenos="12 "></span>2021/11/11 12:44:40 - Write to log.0 - ====================
<span class="linenos" data-linenos="13 "></span>2021/11/11 12:44:40 - Write to log.0 - Finished processing (I=0, O=0, R=1, W=1, U=0, E=0)
<span class="linenos" data-linenos="14 "></span>2021/11/11 12:44:40 - Actualiza lesiones.0 - Finished processing (I=4, O=0, R=4, W=3, U=0, E=1)
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Upsert</p>
<p>Si lo que queremos es que en vez de dar un mensaje de error al no encontrar el registro lo inserte, es necesario utilizar el paso <em>Insert/Update</em>.</p>
</div>
<h2 id="actividades">Actividades<a class="headerlink" href="#actividades" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Realiza los casos prácticos de uso del 1 al 5. En la entrega debes adjuntar tanto el archivo <code>.ktr</code> como capturas de pantallas de los flujos de datos. Antes de realizar cada captura, añade una nota donde aparezca vuestro nombre completo (botón derecho -&gt; <em>New Note</em>).</p>
</li>
<li>
<p>(opcional) Realiza el caso de uso 6, utilizando Amazon RDS o una base de datos en local (puedes elegir PostgreSQL, MariaDB o MySQL).</p>
</li>
<li>
<p>(opcional) Realiza el tutorial oficial sobre PDI, el cual genera una lista de <em>mailing</em> almacenada en una base de datos a partir de un CSV, sobre el cual realiza un proceso de limpieza, formateo, estandarizando y categorización sobre los datos.</p>
</li>
</ol>
<h2 id="referencias">Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://www.packtpub.com/product/pentaho-data-integration-quick-start-guide/9781789343328">Pentaho Data Integration Quick Start Guide</a> de María Carina Roldán.</li>
<li><a href="https://lsi2.ugr.es/jsamos/sm2019/etl-pdi.html">Apuntes de Pentaho</a>, dentro de la asignatura <em>Sistemas Multidimensionales</em>, impartida por <em>José Samos Jiménez</em> en la Universidad de Granada.</li>
<li><a href="https://www.ctranspa.webs.upv.es/wp-content/uploads/2021/03/jnmazon_datathon2021_PDI.pdf">Taller sobre integración de datos (abiertos) / Uso de Pentaho Data Integration</a>, por Jose Norberto Mazón (Universidad de Alicante)</li>
<li><a href="https://help.hitachivantara.com/Documentation/Pentaho/9.2/Setup/Pentaho_Data_Integration_(PDI)_tutorial">Tutorial oficial sobre PDI</a></li>
<li><a href="https://www.youtube.com/playlist?list=PLPgjON4ZM0JBdxxDUAfCS84X79e_2CLNQ">Curso de Spoon</a> en <em>youtube</em> del usuario <em>Learning-BI</em>.</li>
</ul>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Volver al principio
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Pie">
      
        
        <a href="ingesta01.html" class="md-footer__link md-footer__link--prev" aria-label="Anterior: 1.- ETL" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              1.- ETL
            </div>
          </div>
        </a>
      
      
        
        <a href="ingesta03nifi1.html" class="md-footer__link md-footer__link--next" aria-label="Siguiente: 3.- Nifi I" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Siguiente
              </span>
              3.- Nifi I
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2021-2022 Aitor Medrano - Licencia CC BY-NC-SA
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/aitormedrano" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    <a href="mailto:<a.medrano@edu.gva.es>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM178.117 262.104C87.429 196.287 88.353 196.121 64 177.167V152c0-13.255 10.745-24 24-24h272c13.255 0 24 10.745 24 24v25.167c-24.371 18.969-23.434 19.124-114.117 84.938-10.5 7.655-31.392 26.12-45.883 25.894-14.503.218-35.367-18.227-45.883-25.895zM384 217.775V360c0 13.255-10.745 24-24 24H88c-13.255 0-24-10.745-24-24V217.775c13.958 10.794 33.329 25.236 95.303 70.214 14.162 10.341 37.975 32.145 64.694 32.01 26.887.134 51.037-22.041 64.72-32.025 61.958-44.965 81.325-59.406 95.283-70.199z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["header.autohide", "navigation.top", "navigation.expand", "navigation.tracking", "content.code.annotate"], "translations": {"clipboard.copy": "Copiar al portapapeles", "clipboard.copied": "Copiado al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.term.missing": "Falta", "select.version.title": "Seleccionar versi\u00f3n"}, "search": "../assets/javascripts/workers/search.01824240.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.a87c2adc.min.js"></script>
      
    
  </body>
</html>