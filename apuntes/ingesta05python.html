
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Uso de Boto3 para acceder a los servicios de AWS como S3, S3Select, DynamoDB y RDS. Además, mediante Faker creamos datos ficticios para rellenar nuestros datasets.">
      
      
      
        <link rel="canonical" href="https://aitor-medrano.github.io/bigdata2122/apuntes/ingesta05python.html">
      
      <link rel="icon" href="../imagenes/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.10">
    
    
      
        <title>Python y AWS. Uso de Boto3 y Faker. - Inteligencia Artificial y Big Data</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.d6be258b.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
          
          
          <meta name="theme-color" content="#02a6f2">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MV889H0W63"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-MV889H0W63",{page_path:e.pathname})})})</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MV889H0W63"></script>


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="light-blue" data-md-color-accent="teal">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#python-y-aws" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-header__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../imagenes/logoIABD3.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inteligencia Artificial y Big Data
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Python y AWS. Uso de Boto3 y Faker.
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Inteligencia Artificial y Big Data" class="md-nav__button md-logo" aria-label="Inteligencia Artificial y Big Data" data-md-component="logo">
      
  <img src="../imagenes/logoIABD3.png" alt="logo">

    </a>
    Inteligencia Artificial y Big Data
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Inicio
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" data-md-state="indeterminate" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Arquitecturas Big Data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Arquitecturas Big Data" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Arquitecturas Big Data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube01.html" class="md-nav__link">
        1.- Cloud Computing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube02aws.html" class="md-nav__link">
        2.- AWS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube03computacion.html" class="md-nav__link">
        3.- Computación
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube04almacenamiento.html" class="md-nav__link">
        4.- Almacenamiento
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="nube05datos.html" class="md-nav__link">
        5.- Datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="arquitecturas01.html" class="md-nav__link">
        6.- Arquitecturas
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Ingesta de Datos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ingesta de Datos" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Ingesta de Datos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="ingesta01.html" class="md-nav__link">
        1.- ETL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="ingesta02pentaho.html" class="md-nav__link">
        2.- Pentaho DI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="ingesta03nifi1.html" class="md-nav__link">
        3.- Nifi I
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="ingesta04nifi2.html" class="md-nav__link">
        4.- Nifi II
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          5.- Python y AWS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="ingesta05python.html" class="md-nav__link md-nav__link--active">
        5.- Python y AWS
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#sdk-boto3" class="md-nav__link">
    SDK Boto3
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-1-comunicacion-con-s3" class="md-nav__link">
    Caso de uso 1: Comunicación con S3
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-2-cargar-datos-en-dynamodb" class="md-nav__link">
    Caso de uso 2: Cargar datos en DynamoDB
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faker" class="md-nav__link">
    Faker
  </a>
  
    <nav class="md-nav" aria-label="Faker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generando-csv" class="md-nav__link">
    Generando CSV
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generando-json" class="md-nav__link">
    Generando JSON
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-3-consultar-datos-en-dynamodb" class="md-nav__link">
    Caso de uso 3 - Consultar datos en DynamoDB
  </a>
  
    <nav class="md-nav" aria-label="Caso de uso 3 - Consultar datos en DynamoDB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#full-scan" class="md-nav__link">
    Full scan
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-4-de-s3-a-dynamodb" class="md-nav__link">
    Caso de uso 4 - De S3 a DynamoDB
  </a>
  
    <nav class="md-nav" aria-label="Caso de uso 4 - De S3 a DynamoDB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#s3select" class="md-nav__link">
    S3Select
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#de-s3-a-dynamodb" class="md-nav__link">
    De S3 a DynamoDB
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-5-desde-rds" class="md-nav__link">
    Caso de uso 5 - Desde RDS
  </a>
  
    <nav class="md-nav" aria-label="Caso de uso 5 - Desde RDS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mariadbmysql-y-python" class="md-nav__link">
    MariaDB/MySQL y Python
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#de-rds-a-s3" class="md-nav__link">
    De RDS a S3
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#de-rds-a-dynamodb" class="md-nav__link">
    De RDS a DynamoDB
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-6-aws-lambda" class="md-nav__link">
    Caso de uso 6 - AWS Lambda
  </a>
  
    <nav class="md-nav" aria-label="Caso de uso 6 - AWS Lambda">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#desencadenador" class="md-nav__link">
    Desencadenador
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#destino" class="md-nav__link">
    Destino
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" data-md-state="indeterminate" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Big Data Aplicado
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Big Data Aplicado" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Big Data Aplicado
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="bdaplicado01hadoop.html" class="md-nav__link">
        1.- Hadoop
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#sdk-boto3" class="md-nav__link">
    SDK Boto3
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-1-comunicacion-con-s3" class="md-nav__link">
    Caso de uso 1: Comunicación con S3
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-2-cargar-datos-en-dynamodb" class="md-nav__link">
    Caso de uso 2: Cargar datos en DynamoDB
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faker" class="md-nav__link">
    Faker
  </a>
  
    <nav class="md-nav" aria-label="Faker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generando-csv" class="md-nav__link">
    Generando CSV
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generando-json" class="md-nav__link">
    Generando JSON
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-3-consultar-datos-en-dynamodb" class="md-nav__link">
    Caso de uso 3 - Consultar datos en DynamoDB
  </a>
  
    <nav class="md-nav" aria-label="Caso de uso 3 - Consultar datos en DynamoDB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#full-scan" class="md-nav__link">
    Full scan
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-4-de-s3-a-dynamodb" class="md-nav__link">
    Caso de uso 4 - De S3 a DynamoDB
  </a>
  
    <nav class="md-nav" aria-label="Caso de uso 4 - De S3 a DynamoDB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#s3select" class="md-nav__link">
    S3Select
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#de-s3-a-dynamodb" class="md-nav__link">
    De S3 a DynamoDB
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-5-desde-rds" class="md-nav__link">
    Caso de uso 5 - Desde RDS
  </a>
  
    <nav class="md-nav" aria-label="Caso de uso 5 - Desde RDS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mariadbmysql-y-python" class="md-nav__link">
    MariaDB/MySQL y Python
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#de-rds-a-s3" class="md-nav__link">
    De RDS a S3
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#de-rds-a-dynamodb" class="md-nav__link">
    De RDS a DynamoDB
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-de-uso-6-aws-lambda" class="md-nav__link">
    Caso de uso 6 - AWS Lambda
  </a>
  
    <nav class="md-nav" aria-label="Caso de uso 6 - AWS Lambda">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#desencadenador" class="md-nav__link">
    Desencadenador
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#destino" class="md-nav__link">
    Destino
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actividades" class="md-nav__link">
    Actividades
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="python-y-aws">Python y AWS<a class="headerlink" href="#python-y-aws" title="Permanent link">&para;</a></h1>
<p>En esta sesión vamos a estudiar cómo acceder a los servicios de AWS relacionados con el Big Data estudiados previamente, y mediante diversos casos de uso crear diferentes flujos de datos.</p>
<p>Para los siguientes casos de uso, realizaremos los 5 primeros desde nuestro sistema local y el caso final haciendo uso <em>AWS Lambda</em>.</p>
<p>Para autenticarnos en AWS desde nuestro sistema local, recuerda que necesitas copiar las credenciales de acceso en <code>~/.aws/credentials</code> o mediante las <a href="nube02aws.html#variablesEntorno">variables de entorno</a>.</p>
<h2 id="sdk-boto3">SDK Boto3<a class="headerlink" href="#sdk-boto3" title="Permanent link">&para;</a></h2>
<p>Para acceder a AWS desde <em>Python</em>, <em>Amazon</em> ofrece el <a href="https://aws.amazon.com/es/sdk-for-python/">SDK Boto3</a>. Para poder utilizarlo, la instalaremos mediante</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="go">pip install boto3</span>
</code></pre></div>
<p>Podéis consultar toda la información relativa a <em>Boto3</em> en su documentación oficial en
<a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html">https://boto3.amazonaws.com/v1/documentation/api/latest/index.html</a></p>
<p>Existen dos posibilidades para acceder a AWS mediante Boto3:</p>
<ul>
<li><strong>Recursos</strong>: representan un interfaz orientado a objetos de AWS, de manera que cada recurso contendrá un identificador, unos atributos y un conjunto de operaciones. Un ejemplo de recurso es el <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#object">S3</a>. Más información sobre recursos en la <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/resources.html">documentación oficial</a>.</li>
<li><strong>Clientes</strong>: ofrecen un interfaz de bajo nivel que se mapea 1:1 con el API de cada servicio. Los clientes se generan a partir de la definición JSON del servicio. Más información en la <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/clients.html">documentación oficial</a>.</li>
</ul>
<p>En resumen, los recursos son una abstracción a más alto nivel de los servicios AWS que los clientes. Se recomienda el uso de los recursos al no tener que preocuparse de cómo se realiza por debajo la comunicación e interacción con los servicios. Sin embargo, a día de hoy no hay recursos para todos los servicios AWS, y por ello, en ocasiones no queda otra opción que utilizar los clientes.</p>
<p>Para demostrar las diferencias, vamos a ver cómo podemos realizar algunas operaciones haciendo uso del cliente o del recurso (en estos ejemplos nos vamos a centrar en el servicio S3 - <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html">https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html</a>.):</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><input id="__tabbed_1_4" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Buckets de un usuario</label><label for="__tabbed_1_2">Elementos de un bucket</label><label for="__tabbed_1_3">Creación de un bucket</label><label for="__tabbed_1_4">Eliminación de un recurso/bucket</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">s3-buckets.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="c1"># Opción 1</span>
<span class="linenos" data-linenos=" 4 "></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Buckets mediante resource:&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">s3resource</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">buckets</span> <span class="o">=</span> <span class="n">s3resource</span><span class="o">.</span><span class="n">buckets</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="linenos" data-linenos=" 7 "></span><span class="k">for</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="n">buckets</span><span class="p">:</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">bucket</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="c1"># Opción 2</span>
<span class="linenos" data-linenos="11 "></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Buckets mediante el cliente:&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="12 "></span><span class="n">s3client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="13 "></span><span class="n">response</span> <span class="o">=</span> <span class="n">s3client</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">()</span>
<span class="linenos" data-linenos="14 "></span><span class="k">for</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Buckets&#39;</span><span class="p">]:</span>
<span class="linenos" data-linenos="15 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">s3-bucket-objects.py</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos="2 "></span>
<span class="linenos" data-linenos="3 "></span><span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="4 "></span><span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="s1">&#39;s3severo2122python&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="5 "></span><span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bucket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
<span class="linenos" data-linenos="6 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">s3-create-bucket.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="c1"># Opción 1 - resource</span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">s3r</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">bucket</span> <span class="o">=</span> <span class="n">s3r</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="s1">&#39;s3severo2122python-r&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">bucket</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1"># Opción 2 - cliente</span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">s3c</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="10 "></span><span class="n">response</span> <span class="o">=</span> <span class="n">s3c</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span>
<span class="linenos" data-linenos="11 "></span>    <span class="n">Bucket</span><span class="o">=</span><span class="s1">&#39;s3severo2122python&#39;</span>
<span class="linenos" data-linenos="12 "></span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">s3-delete.py</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos="2 "></span>
<span class="linenos" data-linenos="3 "></span><span class="n">s3r</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="4 "></span><span class="n">bucket</span> <span class="o">=</span> <span class="n">s3r</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="s1">&#39;s3severo2122python&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="5 "></span>
<span class="linenos" data-linenos="6 "></span><span class="c1"># Elimina todos los objetos del bucket</span>
<span class="linenos" data-linenos="7 "></span><span class="n">bucket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="linenos" data-linenos="8 "></span><span class="c1"># Elimina el bucket</span>
<span class="linenos" data-linenos="9 "></span><span class="n">bucket</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="caso-de-uso-1-comunicacion-con-s3">Caso de uso 1: Comunicación con S3<a class="headerlink" href="#caso-de-uso-1-comunicacion-con-s3" title="Permanent link">&para;</a></h2>
<p>Vamos a trabajar con el archivo <a href="../recursos/dynamodb/datosPeliculas.json">datosPeliculas.json</a> el cual contiene un listado de películas con las que trabajaremos en los siguientes casos de uso.</p>
<p>Primero vamos a ver cómo podemos subir el archivo a S3 mediante Python:</p>
<div class="highlight"><span class="filename">upload-films-s3.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">ficheroUpload</span> <span class="o">=</span> <span class="s2">&quot;datosPeliculas.json&quot;</span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">nombreBucket</span> <span class="o">=</span> <span class="s2">&quot;s3severo2122python&quot;</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1"># Opción 1 - resource</span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">s3r</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1"># 1.1 mediante upload_file</span>
<span class="linenos" data-linenos="10 "></span><span class="n">bucket</span> <span class="o">=</span> <span class="n">s3r</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">nombreBucket</span><span class="p">,</span> <span class="s1">&#39;datosSubidosR1.txt&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="11 "></span><span class="n">bucket</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">ficheroUpload</span><span class="p">)</span>
<span class="linenos" data-linenos="12 "></span>
<span class="linenos" data-linenos="13 "></span><span class="c1"># 1.2 mediante put</span>
<span class="linenos" data-linenos="14 "></span><span class="nb">object</span> <span class="o">=</span> <span class="n">s3r</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">nombreBucket</span><span class="p">,</span> <span class="s1">&#39;datosSubidosR2.txt&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="15 "></span><span class="nb">object</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">Body</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;Ejemplo de datos binarios&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span><span class="c1"># Opción 2 - cliente</span>
<span class="linenos" data-linenos="18 "></span><span class="n">s3c</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="19 "></span>
<span class="linenos" data-linenos="20 "></span><span class="c1"># 2.1 mediante upload_file</span>
<span class="linenos" data-linenos="21 "></span><span class="n">response</span> <span class="o">=</span> <span class="n">s3c</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">ficheroUpload</span><span class="p">,</span> <span class="n">nombreBucket</span><span class="p">,</span> <span class="s2">&quot;datosSubidosC1.json&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="22 "></span>
<span class="linenos" data-linenos="23 "></span><span class="c1"># 2.2 mediante upload_fileobj</span>
<span class="linenos" data-linenos="24 "></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ficheroUpload</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="linenos" data-linenos="25 "></span>    <span class="n">s3c</span><span class="o">.</span><span class="n">upload_fileobj</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">nombreBucket</span><span class="p">,</span> <span class="s2">&quot;datosSubidosC2.json&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="26 "></span>
<span class="linenos" data-linenos="27 "></span><span class="c1"># Cliente: Ejemplo de como crear un objeto y añadirle contenido desde Python</span>
<span class="linenos" data-linenos="28 "></span><span class="n">s3c</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span><span class="n">Body</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;Ejemplo de datos binarios&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="29 "></span>               <span class="n">Bucket</span><span class="o">=</span><span class="n">nombreBucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="s2">&quot;datosSubidosC3&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Si lo que queremos es descargar un recurso de S3 para tenerlo en nuestro sistema local haremos:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="c1"># Opción 1 - descarga</span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">s3c</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">s3c</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;s3severo2122python&#39;</span><span class="p">,</span> <span class="s1">&#39;datosPeliculas.json&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span>                 <span class="s1">&#39;datosDescargados.json&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1"># Opción 2 - Abrimos el fichero y metemos el contenido</span>
<span class="linenos" data-linenos=" 9 "></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;fichero.json&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="linenos" data-linenos="10 "></span>    <span class="n">s3c</span><span class="o">.</span><span class="n">download_fileobj</span><span class="p">(</span><span class="s1">&#39;s3severo2122python&#39;</span><span class="p">,</span> <span class="s1">&#39;datosPeliculas.json&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</code></pre></div>
<h2 id="caso-de-uso-2-cargar-datos-en-dynamodb">Caso de uso 2: Cargar datos en DynamoDB<a class="headerlink" href="#caso-de-uso-2-cargar-datos-en-dynamodb" title="Permanent link">&para;</a></h2>
<p>Vamos a cargar un listado de películas en <em>DynamoDB</em>. El primer paso es elegir las claves de particionado y ordenación. El archivo <a href="../recursos/dynamodb/datosPeliculas.json">datosPeliculas.json</a> contiene el siguiente contenido:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">[</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 3 "></span>        <span class="nt">&quot;year&quot;</span><span class="p">:</span> <span class="mi">2013</span><span class="p">,</span>
<span class="linenos" data-linenos=" 4 "></span>        <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Rush&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span>        <span class="nt">&quot;info&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 6 "></span>            <span class="nt">&quot;directors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Ron Howard&quot;</span><span class="p">],</span>
<span class="linenos" data-linenos=" 7 "></span>            <span class="nt">&quot;release_date&quot;</span><span class="p">:</span> <span class="s2">&quot;2013-09-02T00:00:00Z&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="nt">&quot;rating&quot;</span><span class="p">:</span> <span class="mf">8.3</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="nt">&quot;genres&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="linenos" data-linenos="10 "></span>                <span class="s2">&quot;Action&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="11 "></span>                <span class="s2">&quot;Biography&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="12 "></span>                <span class="s2">&quot;Drama&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="13 "></span>                <span class="s2">&quot;Sport&quot;</span>
<span class="linenos" data-linenos="14 "></span>            <span class="p">],</span>
<span class="linenos" data-linenos="15 "></span>            <span class="nt">&quot;image_url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://ia.media-imdb.com/images/M/MV5BMTQyMDE0MTY0OV5BMl5BanBnXkFtZTcwMjI2OTI0OQ@@._V1_SX400_.jpg&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="16 "></span>            <span class="nt">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;A re-creation of the merciless 1970s rivalry between Formula One rivals James Hunt and Niki Lauda.&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="17 "></span>            <span class="nt">&quot;rank&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos" data-linenos="18 "></span>            <span class="nt">&quot;running_time_secs&quot;</span><span class="p">:</span> <span class="mi">7380</span><span class="p">,</span>
<span class="linenos" data-linenos="19 "></span>            <span class="nt">&quot;actors&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="linenos" data-linenos="20 "></span>                <span class="s2">&quot;Daniel Bruhl&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="21 "></span>                <span class="s2">&quot;Chris Hemsworth&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="22 "></span>                <span class="s2">&quot;Olivia Wilde&quot;</span>
<span class="linenos" data-linenos="23 "></span>            <span class="p">]</span>
<span class="linenos" data-linenos="24 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="25 "></span>    <span class="p">},</span>
<span class="linenos" data-linenos="26 "></span><span class="p">]</span>
</code></pre></div>
<p>Como los años de las películas permiten particionar de manera más o menos equilibrada los datos, en la mejor candidata para clave de particionado. Como sí que habrá varias películas en el mismo año, elegimos el título como clave de ordenación, provocando que los documentos tengan una clave compuesta.</p>
<p>Así pues, vamos a nombrar nuestra tabla como <code>SeveroPeliculas</code> y ponemos como clave de partición el atributo <code>year</code> de tipo númerico, y como clave de ordenación <code>title</code> de tipo cadena.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/05ddCrearTabla.png">
    <figcaption>Creación de la tabla SeveroPeliculas</figcaption>
</figure>

<p>Una vez creada la tabla, vamos a ver cómo podemos cargar los datos. Haciendo uso de la librería <em>boto3</em> vamos a crear el archivo <a href="../recursos/dynamodb/cargarDatosPeliculas.py">cargarDatosPeliculas.py</a>:</p>
<div class="highlight"><span class="filename">cargarDatosPeliculas.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">import</span> <span class="nn">decimal</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span> <span class="c1"># (1)</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">tabla</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;SeveroPeliculas&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;datosPeliculas.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ficheroJSON</span><span class="p">:</span>
<span class="linenos" data-linenos="10 "></span>    <span class="n">peliculas</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ficheroJSON</span><span class="p">,</span> <span class="n">parse_float</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">)</span>
<span class="linenos" data-linenos="11 "></span>    <span class="k">for</span> <span class="n">pelicula</span> <span class="ow">in</span> <span class="n">peliculas</span><span class="p">:</span>
<span class="linenos" data-linenos="12 "></span>        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">movie</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">])</span>
<span class="linenos" data-linenos="13 "></span>        <span class="n">title</span> <span class="o">=</span> <span class="n">movie</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
<span class="linenos" data-linenos="14 "></span>        <span class="n">info</span> <span class="o">=</span> <span class="n">movie</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>
<span class="linenos" data-linenos="15 "></span>
<span class="linenos" data-linenos="16 "></span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Añadida película:&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
<span class="linenos" data-linenos="17 "></span>
<span class="linenos" data-linenos="18 "></span>        <span class="n">tabla</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
<span class="linenos" data-linenos="19 "></span>            <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
<span class="linenos" data-linenos="20 "></span>                <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span>
<span class="linenos" data-linenos="21 "></span>                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
<span class="linenos" data-linenos="22 "></span>                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">,</span>
<span class="linenos" data-linenos="23 "></span>            <span class="p">}</span>
<span class="linenos" data-linenos="24 "></span>        <span class="p">)</span>
</code></pre></div>
<ol>
<li>Nos conectamos a la región e indicamos que vamos a utilizar el servicio de DynamoDB</li>
</ol>
<p>Si lo ejecutamos desde nuestro ordenador, nos aparecerá por la consola cada una de las películas insertadas.</p>
<div class="admonition caution">
<p class="admonition-title">Float y boto3</p>
<p>Mucho cuidado con boto3 y DynamoDB, ya que los tipos <code>Float</code> no están soportados, y en cambio, hemos de utilizar el tipo <code>Decimal</code>.</p>
</div>
<h2 id="faker">Faker<a class="headerlink" href="#faker" title="Permanent link">&para;</a></h2>
<p>Si necesitamos escribir muchos datos, es muy útil emplear una librería como <a href="https://faker.readthedocs.io/en/master/">Faker</a> para generar los datos.</p>
<p>Primero hemos de instalarla mediante pip:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>pip3 install faker
</code></pre></div>
<p>Vamos a realizar un ejemplo para mostrar algunos datos aleatorios y comprobar su funcionamiento:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Código</label><label for="__tabbed_2_2">Resultado</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">holaFaker.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">faker</span> <span class="kn">import</span> <span class="n">Faker</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">fake</span> <span class="o">=</span> <span class="n">Faker</span><span class="p">()</span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">fake</span> <span class="o">=</span> <span class="n">Faker</span><span class="p">(</span><span class="s1">&#39;es_ES&#39;</span><span class="p">)</span>   <span class="c1"># cambiamos el locale a español</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nombre:&quot;</span><span class="p">,</span> <span class="n">fake</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
<span class="linenos" data-linenos=" 7 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dirección:&quot;</span><span class="p">,</span> <span class="n">fake</span><span class="o">.</span><span class="n">address</span><span class="p">())</span>
<span class="linenos" data-linenos=" 8 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nombre de hombre:&quot;</span><span class="p">,</span> <span class="n">fake</span><span class="o">.</span><span class="n">first_name_male</span><span class="p">())</span>
<span class="linenos" data-linenos=" 9 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Número de teléfono:&quot;</span><span class="p">,</span> <span class="n">fake</span><span class="o">.</span><span class="n">phone_number</span><span class="p">())</span>
<span class="linenos" data-linenos="10 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Color:&quot;</span><span class="p">,</span> <span class="n">fake</span><span class="o">.</span><span class="n">color_name</span><span class="p">())</span>
<span class="linenos" data-linenos="11 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fecha:&quot;</span><span class="p">,</span> <span class="n">fake</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
<span class="linenos" data-linenos="12 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Email:&quot;</span><span class="p">,</span> <span class="n">fake</span><span class="o">.</span><span class="n">email</span><span class="p">())</span>
<span class="linenos" data-linenos="13 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Frase de 10 palabras&quot;</span><span class="p">,</span> <span class="n">fake</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="n">nb_words</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="go">Nombre: Dani Pla Chico</span>
<span class="linenos" data-linenos="2 "></span><span class="go">Dirección: Cuesta de Emiliano Milla 66</span>
<span class="linenos" data-linenos="3 "></span><span class="go">Albacete, 83227</span>
<span class="linenos" data-linenos="4 "></span><span class="go">Nombre de hombre: Matías</span>
<span class="linenos" data-linenos="5 "></span><span class="go">Número de teléfono: +34 818 779 827</span>
<span class="linenos" data-linenos="6 "></span><span class="go">Color: Salmón oscuro</span>
<span class="linenos" data-linenos="7 "></span><span class="go">Fecha: 1984-09-29</span>
<span class="linenos" data-linenos="8 "></span><span class="go">Email: btome@example.net</span>
<span class="linenos" data-linenos="9 "></span><span class="go">Frase de 10 palabras Perferendis saepe consequatur saepe sapiente est impedit eaque omnis temporibus excepturi repellat ducimus.</span>
</code></pre></div>
</div>
</div>
</div>
<p>Los diferentes grupos de datos que genera se agrupan en <em>Providers</em>: de dirección, fechas, relacionados con internet, bancarios, códigos de barra, isbn, etc... Se recomienda consultar la documentación en <a href="https://faker.readthedocs.io/en/master/providers.html">https://faker.readthedocs.io/en/master/providers.html</a>.</p>
<div class="admonition caution">
<p class="admonition-title">Locale ES</p>
<p>Al trabajar con el idioma en español, puede que algunos métodos no funcionen (más que no funcionar, posiblemente tengan otro nombre). Es recomendable comprobar las opciones disponibles en <a href="https://faker.readthedocs.io/en/master/locales/es_ES.html">https://faker.readthedocs.io/en/master/locales/es_ES.html</a></p>
</div>
<h3 id="generando-csv">Generando CSV<a class="headerlink" href="#generando-csv" title="Permanent link">&para;</a></h3>
<p>Vamos a generar un CSV con datos de 1000 personas. Primero creamos una lista con los encabezados y los escribimos en el fichero, para posteriormente, línea a línea, generar los datos de cada persona:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Código</label><label for="__tabbed_3_2">Resultado</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">generaCSV.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">faker</span> <span class="kn">import</span> <span class="n">Faker</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">csv</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">output</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;datosFaker.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">fake</span> <span class="o">=</span> <span class="n">Faker</span><span class="p">(</span><span class="s1">&#39;es_ES&#39;</span><span class="p">)</span>   <span class="c1"># cambiamos el locale a español</span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nombre&#39;</span><span class="p">,</span> <span class="s1">&#39;edad&#39;</span><span class="p">,</span> <span class="s1">&#39;calle&#39;</span><span class="p">,</span> <span class="s1">&#39;ciudad&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="s1">&#39;provincia&#39;</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;longitud&#39;</span><span class="p">,</span> <span class="s1">&#39;latitud&#39;</span><span class="p">]</span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">mywriter</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="linenos" data-linenos="10 "></span><span class="n">mywriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">mywriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">fake</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
<span class="linenos" data-linenos="14 "></span>                    <span class="n">fake</span><span class="o">.</span><span class="n">random_int</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="linenos" data-linenos="15 "></span>                    <span class="n">fake</span><span class="o">.</span><span class="n">street_address</span><span class="p">(),</span>
<span class="linenos" data-linenos="16 "></span>                    <span class="n">fake</span><span class="o">.</span><span class="n">city</span><span class="p">(),</span>
<span class="linenos" data-linenos="17 "></span>                    <span class="n">fake</span><span class="o">.</span><span class="n">state</span><span class="p">(),</span>
<span class="linenos" data-linenos="18 "></span>                    <span class="n">fake</span><span class="o">.</span><span class="n">postcode</span><span class="p">(),</span>
<span class="linenos" data-linenos="19 "></span>                    <span class="n">fake</span><span class="o">.</span><span class="n">longitude</span><span class="p">(),</span>
<span class="linenos" data-linenos="20 "></span>                    <span class="n">fake</span><span class="o">.</span><span class="n">latitude</span><span class="p">()])</span>
<span class="linenos" data-linenos="21 "></span><span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">datosFaker.csv</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span>nombre,edad,calle,ciudad,provincia,cp,longitud,latitud
<span class="linenos" data-linenos="2 "></span>Jenaro Verdú Suarez,26,Urbanización Mohamed Vallés 122,Sevilla,Guipúzcoa,73198,2.657719,-69.679293
<span class="linenos" data-linenos="3 "></span>Eugenio Calzada Revilla,57,Camino Vanesa Amor 36 Piso 9 ,Huesca,Álava,75590,34.041399,-52.924628
<span class="linenos" data-linenos="4 "></span>Flavio del Lumbreras,76,Avenida de Beatriz Amaya 92,Ciudad,Murcia,86420,58.248903,-17.924926
</code></pre></div>
</div>
</div>
</div>
<h3 id="generando-json">Generando JSON<a class="headerlink" href="#generando-json" title="Permanent link">&para;</a></h3>
<p>Y a continuación repetimos el mismo ejemplo, pero ahora generando un documento JSON. La principal diferencia es que primero vamos a rellenar un diccionario con toda la información, y luego persistimos el diccionario:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Código</label><label for="__tabbed_4_2">Resultado</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">generaJSON.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">faker</span> <span class="kn">import</span> <span class="n">Faker</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">fake</span> <span class="o">=</span> <span class="n">Faker</span><span class="p">(</span><span class="s1">&#39;es_ES&#39;</span><span class="p">)</span>   <span class="c1"># cambiamos el locale a español</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1"># Preparamos los datos</span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">datos</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">datos</span><span class="p">[</span><span class="s1">&#39;registros&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
<span class="linenos" data-linenos="11 "></span>    <span class="n">persona</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;datos&quot;</span><span class="p">:</span> <span class="n">fake</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
<span class="linenos" data-linenos="12 "></span>            <span class="s2">&quot;edad&quot;</span><span class="p">:</span> <span class="n">fake</span><span class="o">.</span><span class="n">random_int</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="linenos" data-linenos="13 "></span>            <span class="s2">&quot;calle&quot;</span><span class="p">:</span> <span class="n">fake</span><span class="o">.</span><span class="n">street_address</span><span class="p">(),</span>
<span class="linenos" data-linenos="14 "></span>            <span class="s2">&quot;ciudad&quot;</span><span class="p">:</span> <span class="n">fake</span><span class="o">.</span><span class="n">city</span><span class="p">(),</span>
<span class="linenos" data-linenos="15 "></span>            <span class="s2">&quot;provincia&quot;</span><span class="p">:</span> <span class="n">fake</span><span class="o">.</span><span class="n">state</span><span class="p">(),</span>
<span class="linenos" data-linenos="16 "></span>            <span class="s2">&quot;cp&quot;</span><span class="p">:</span> <span class="n">fake</span><span class="o">.</span><span class="n">postcode</span><span class="p">(),</span>
<span class="linenos" data-linenos="17 "></span>            <span class="s2">&quot;longitud&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">longitude</span><span class="p">()),</span>
<span class="linenos" data-linenos="18 "></span>            <span class="s2">&quot;latitud&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">latitude</span><span class="p">())}</span>
<span class="linenos" data-linenos="19 "></span>    <span class="n">datos</span><span class="p">[</span><span class="s1">&#39;registros&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">persona</span><span class="p">)</span>
<span class="linenos" data-linenos="20 "></span>
<span class="linenos" data-linenos="21 "></span><span class="c1"># Los metemos en el fichero</span>
<span class="linenos" data-linenos="22 "></span><span class="n">output</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;datosFaker.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="23 "></span><span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">datos</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">datosFaker.json</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="nt">&quot;registros&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="linenos" data-linenos=" 3 "></span>        <span class="p">{</span>
<span class="linenos" data-linenos=" 4 "></span>            <span class="nt">&quot;datos&quot;</span><span class="p">:</span> <span class="s2">&quot;Merche Moreno Roman&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span>            <span class="nt">&quot;edad&quot;</span><span class="p">:</span> <span class="mi">51</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span>            <span class="nt">&quot;calle&quot;</span><span class="p">:</span> <span class="s2">&quot;Paseo Amelia Folch 967&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span>            <span class="nt">&quot;ciudad&quot;</span><span class="p">:</span> <span class="s2">&quot;Segovia&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="nt">&quot;provincia&quot;</span><span class="p">:</span> <span class="s2">&quot;M\u00e1laga&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="nt">&quot;cp&quot;</span><span class="p">:</span> <span class="s2">&quot;71721&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>            <span class="nt">&quot;longitud&quot;</span><span class="p">:</span> <span class="mf">84.603801</span><span class="p">,</span>
<span class="linenos" data-linenos="11 "></span>            <span class="nt">&quot;latitud&quot;</span><span class="p">:</span> <span class="mf">58.941349</span>
<span class="linenos" data-linenos="12 "></span>        <span class="p">},</span>
<span class="linenos" data-linenos="13 "></span>        <span class="p">{</span>
<span class="linenos" data-linenos="14 "></span>            <span class="nt">&quot;datos&quot;</span><span class="p">:</span> <span class="s2">&quot;Miguel Abascal Sanz&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="15 "></span>            <span class="nt">&quot;edad&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="caso-de-uso-3-consultar-datos-en-dynamodb">Caso de uso 3 - Consultar datos en DynamoDB<a class="headerlink" href="#caso-de-uso-3-consultar-datos-en-dynamodb" title="Permanent link">&para;</a></h2>
<p>Una vez tenemos nuestra tabla de DynamoDB cargada con datos, llega el momento de recuperar los datos, ya sea un registro en concreto o la posibilidad de realizar una consulta, ya sea por su índice o su clave de ordenación (o ambas).</p>
<p>En la sesión que trabajamos con DynamoDB estudiamos que podíamos realizar consultas sobre el almacén NoSQL haciendo uso de un subconjunto de SQL conocido como <a href="https://aitor-medrano.github.io/bigdata2122/apuntes/nube05datos.html#infraestructura">PartiQL</a>. En los siguientes ejemplos vamos a mostrar cómo realizar las operaciones vía el API de DynamoDb y mediante PartiQL.</p>
<p>Si queremos recuperar la película <em>Interstellar</em> de 2014 haremos:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:3"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><input id="__tabbed_5_3" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">Mediante <code>get_item</code></label><label for="__tabbed_5_2">Mediante <code>get_item</code> con excepciones</label><label for="__tabbed_5_3">Mediante PartiQL</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">dynamodb_getitem.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">tabla</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;SeveroPeliculas&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Interstellar&quot;</span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">year</span> <span class="o">=</span> <span class="mi">2014</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">response</span> <span class="o">=</span> <span class="n">tabla</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span>
<span class="linenos" data-linenos="10 "></span>        <span class="n">Key</span><span class="o">=</span><span class="p">{</span>
<span class="linenos" data-linenos="11 "></span>            <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span>
<span class="linenos" data-linenos="12 "></span>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span>
<span class="linenos" data-linenos="13 "></span>        <span class="p">},</span>
<span class="linenos" data-linenos="14 "></span>        <span class="n">ProjectionExpression</span><span class="o">=</span><span class="s2">&quot;title, info.plot&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="15 "></span><span class="n">item</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Item&#39;</span><span class="p">]</span>
<span class="linenos" data-linenos="16 "></span><span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">dynamodb_getitem_exc.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">from</span> <span class="nn">botocore.exceptions</span> <span class="kn">import</span> <span class="n">ClientError</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">tabla</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;SeveroPeliculas&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Interstellar&quot;</span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">year</span> <span class="o">=</span> <span class="mi">2014</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="c1"># Recupera una película</span>
<span class="linenos" data-linenos="11 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------ Datos de Interstellar&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="12 "></span><span class="k">try</span><span class="p">:</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">response</span> <span class="o">=</span> <span class="n">tabla</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span>
<span class="linenos" data-linenos="14 "></span>        <span class="n">Key</span><span class="o">=</span><span class="p">{</span>
<span class="linenos" data-linenos="15 "></span>            <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span>
<span class="linenos" data-linenos="16 "></span>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span>
<span class="linenos" data-linenos="17 "></span>        <span class="p">},</span>
<span class="linenos" data-linenos="18 "></span>        <span class="n">ProjectionExpression</span><span class="o">=</span><span class="s2">&quot;title, info.plot&quot;</span>
<span class="linenos" data-linenos="19 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="20 "></span><span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos" data-linenos="21 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Message&#39;</span><span class="p">])</span>
<span class="linenos" data-linenos="22 "></span><span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="23 "></span>    <span class="n">item</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Item&#39;</span><span class="p">]</span>
<span class="linenos" data-linenos="24 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">dynamodb_select.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">clientDDB</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="c1"># Recupera una película con PartiQL</span>
<span class="linenos" data-linenos=" 6 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------ Datos de Interstellar mediante PartiQL&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">resp</span> <span class="o">=</span> <span class="n">clientDDB</span><span class="o">.</span><span class="n">execute_statement</span><span class="p">(</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="n">Statement</span><span class="o">=</span><span class="s2">&quot;SELECT title, info.plot FROM SeveroPeliculas WHERE year = 2014 and title=&#39;Interstellar&#39;&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">item</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos" data-linenos="10 "></span><span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Interstellar&quot;</span>
<span class="linenos" data-linenos="13 "></span><span class="n">year</span> <span class="o">=</span> <span class="mi">2014</span>
<span class="linenos" data-linenos="14 "></span><span class="c1"># Recupera una película con PartiQL con parámetros indicados mediante ?</span>
<span class="linenos" data-linenos="15 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------ Datos de Interstellar mediante PartiQL con parámetros&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="16 "></span><span class="n">resp</span> <span class="o">=</span> <span class="n">clientDDB</span><span class="o">.</span><span class="n">execute_statement</span><span class="p">(</span><span class="n">Statement</span><span class="o">=</span><span class="s1">&#39;SELECT * FROM SeveroPeliculas WHERE year = ? AND title = ?&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="17 "></span>                                    <span class="n">Parameters</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)},</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">}])</span>
<span class="linenos" data-linenos="18 "></span><span class="n">item</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos" data-linenos="19 "></span><span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
<p>En el caso de las <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/dynamodb.html#DynamoDB.Client.execute_statement">consultas mediante PartiQL haciendo uso de <code>execute_statement</code></a> conviene destacar que:</p>
<ul>
<li>Las consultas son <em>case sensitive</em>.</li>
<li>Los parámetros se indican mediante <code>?</code></li>
<li>Los contenidos de los parámetros se indican mediante una lista con un diccionario por cada parámetro donde la clave es el tipo del parámetro, y el valor es el dato a pasar (el dato se pasa siempre como un <code>string</code>)</li>
<li>Las consultas siempre devuelven un diccionario con una propiedad <code>Items</code> que contiene los resultados devueltos.</li>
</ul>
<p>Destacar que es diferente la estructura del resultado de realizar una consulta mediante el API de DynamoDB (respeta la estructura definida en la base de datos) o mediante PartiQL (crea un atributo por columna recuperada cuyo valor contiene el tipo del dato):</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Resultado de <code>get-item</code></label><label for="__tabbed_6_2">Resultado de <em>PartiQL</em></label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span>
<span class="linenos" data-linenos="2 "></span>    <span class="err">&#39;i</span><span class="kc">nf</span><span class="err">o&#39;</span><span class="p">:</span> <span class="p">{</span><span class="err">&#39;plo</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;A</span> <span class="err">group</span> <span class="err">o</span><span class="kc">f</span> <span class="err">explorers</span> <span class="err">make</span> <span class="err">use</span> <span class="err">o</span><span class="kc">f</span> <span class="err">a</span> <span class="kc">ne</span><span class="err">wly</span> <span class="err">discovered</span> <span class="err">wormhole</span> <span class="kc">t</span><span class="err">o</span> <span class="err">surpass</span> <span class="kc">t</span><span class="err">he</span> <span class="err">limi</span><span class="kc">tat</span><span class="err">io</span><span class="kc">ns</span> <span class="err">o</span><span class="kc">n</span> <span class="err">huma</span><span class="kc">n</span> <span class="err">space</span> <span class="kc">tra</span><span class="err">vel</span> <span class="err">a</span><span class="kc">n</span><span class="err">d</span> <span class="err">co</span><span class="kc">n</span><span class="err">quer</span> <span class="kc">t</span><span class="err">he</span> <span class="err">vas</span><span class="kc">t</span> <span class="err">dis</span><span class="kc">tan</span><span class="err">ces</span> <span class="err">i</span><span class="kc">n</span><span class="err">volved</span> <span class="err">i</span><span class="kc">n</span> <span class="err">a</span><span class="kc">n</span> <span class="err">i</span><span class="kc">nterstellar</span> <span class="err">voyage.&#39;</span><span class="p">},</span>
<span class="linenos" data-linenos="3 "></span>    <span class="err">&#39;</span><span class="kc">t</span><span class="err">i</span><span class="kc">tle</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;I</span><span class="kc">nterstellar</span><span class="err">&#39;</span>
<span class="linenos" data-linenos="4 "></span><span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span>
<span class="linenos" data-linenos="2 "></span>    <span class="err">&#39;</span><span class="kc">t</span><span class="err">i</span><span class="kc">tle</span><span class="err">&#39;</span><span class="p">:</span> <span class="p">{</span><span class="err">&#39;S&#39;</span><span class="p">:</span> <span class="err">&#39;I</span><span class="kc">nterstellar</span><span class="err">&#39;</span><span class="p">},</span>
<span class="linenos" data-linenos="3 "></span>    <span class="err">&#39;plo</span><span class="kc">t</span><span class="err">&#39;</span><span class="p">:</span> <span class="p">{</span><span class="err">&#39;S&#39;</span><span class="p">:</span> <span class="err">&#39;A</span> <span class="err">group</span> <span class="err">o</span><span class="kc">f</span> <span class="err">explorers</span> <span class="err">make</span> <span class="err">use</span> <span class="err">o</span><span class="kc">f</span> <span class="err">a</span> <span class="kc">ne</span><span class="err">wly</span> <span class="err">discovered</span> <span class="err">wormhole</span> <span class="kc">t</span><span class="err">o</span> <span class="err">surpass</span> <span class="kc">t</span><span class="err">he</span> <span class="err">limi</span><span class="kc">tat</span><span class="err">io</span><span class="kc">ns</span> <span class="err">o</span><span class="kc">n</span> <span class="err">huma</span><span class="kc">n</span> <span class="err">space</span> <span class="kc">tra</span><span class="err">vel</span> <span class="err">a</span><span class="kc">n</span><span class="err">d</span> <span class="err">co</span><span class="kc">n</span><span class="err">quer</span> <span class="kc">t</span><span class="err">he</span> <span class="err">vas</span><span class="kc">t</span> <span class="err">dis</span><span class="kc">tan</span><span class="err">ces</span> <span class="err">i</span><span class="kc">n</span><span class="err">volved</span> <span class="err">i</span><span class="kc">n</span> <span class="err">a</span><span class="kc">n</span> <span class="err">i</span><span class="kc">nterstellar</span> <span class="err">voyage.&#39;</span><span class="p">}</span>
<span class="linenos" data-linenos="4 "></span><span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>También podemos realizar otro tipo de consultas:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">Películas de 2016 mediante <code>query</code></label><label for="__tabbed_7_2">Películas cuyo título esté entre la A y la L</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">from</span> <span class="nn">boto3.dynamodb.conditions</span> <span class="kn">import</span> <span class="n">Key</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="c1"># Mediante query</span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">tabla</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;SeveroPeliculas&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 7 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----Películas de 2016&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">resp</span> <span class="o">=</span> <span class="n">tabla</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">KeyConditionExpression</span><span class="o">=</span><span class="n">Key</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">2016</span><span class="p">))</span>
<span class="linenos" data-linenos=" 9 "></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">]:</span>
<span class="linenos" data-linenos="10 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="c1"># Mediante PartiQL</span>
<span class="linenos" data-linenos="13 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----Películas de 2016 con PartiQL&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="14 "></span><span class="n">clientDDB</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="15 "></span><span class="n">resp</span> <span class="o">=</span> <span class="n">clientDDB</span><span class="o">.</span><span class="n">execute_statement</span><span class="p">(</span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">Statement</span><span class="o">=</span><span class="s2">&quot;SELECT title, year FROM SeveroPeliculas WHERE year = 2016&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="17 "></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">]:</span>
<span class="linenos" data-linenos="18 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">][</span><span class="s1">&#39;S&#39;</span><span class="p">])</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">import</span> <span class="nn">decimal</span>
<span class="linenos" data-linenos=" 4 "></span><span class="kn">from</span> <span class="nn">boto3.dynamodb.conditions</span> <span class="kn">import</span> <span class="n">Key</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="k">class</span> <span class="nc">DecimalEncoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">):</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="k">if</span> <span class="n">o</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos" data-linenos="10 "></span>                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="linenos" data-linenos="11 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="12 "></span>                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="linenos" data-linenos="13 "></span>        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DecimalEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span><span class="n">anyo</span> <span class="o">=</span> <span class="mi">2016</span>
<span class="linenos" data-linenos="16 "></span><span class="n">letraInicial</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span>
<span class="linenos" data-linenos="17 "></span><span class="n">letraFinal</span> <span class="o">=</span> <span class="s2">&quot;F&quot;</span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="20 "></span><span class="n">tabla</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;SeveroPeliculas&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="21 "></span>
<span class="linenos" data-linenos="22 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----Películas de 2016 cuyo título empieza desde A hasta L&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="23 "></span><span class="n">resp</span> <span class="o">=</span> <span class="n">tabla</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
<span class="linenos" data-linenos="24 "></span>    <span class="n">ProjectionExpression</span><span class="o">=</span><span class="s2">&quot;#yr, title, info.genres, info.actors[0]&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="25 "></span>    <span class="c1"># year es una palabra clave, por tanto necesitamos crear un alias</span>
<span class="linenos" data-linenos="26 "></span>    <span class="n">ExpressionAttributeNames</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;#yr&quot;</span><span class="p">:</span> <span class="s2">&quot;year&quot;</span><span class="p">},</span>
<span class="linenos" data-linenos="27 "></span>    <span class="n">KeyConditionExpression</span><span class="o">=</span><span class="n">Key</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">anyo</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Key</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">letraInicial</span><span class="p">,</span> <span class="n">letraFinal</span><span class="p">)</span>
<span class="linenos" data-linenos="28 "></span><span class="p">)</span>
<span class="linenos" data-linenos="29 "></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">]:</span>
<span class="linenos" data-linenos="30 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="linenos" data-linenos="31 "></span>    <span class="c1"># {&#39;info&#39;: {&#39;actors&#39;: [&#39;Zoe Saldana&#39;], &#39;genres&#39;: [&#39;Action&#39;, &#39;Adventure&#39;, &#39;Fantasy&#39;, &#39;Sci-Fi&#39;]}, &#39;year&#39;: Decimal(&#39;2016&#39;), &#39;title&#39;: &#39;Avatar 2&#39;}</span>
<span class="linenos" data-linenos="32 "></span>    <span class="c1"># Transforma los valores numéricos de Decimal a Number</span>
<span class="linenos" data-linenos="33 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">DecimalEncoder</span><span class="p">))</span>
<span class="linenos" data-linenos="34 "></span>    <span class="c1"># {&quot;info&quot;: {&quot;actors&quot;: [&quot;Zoe Saldana&quot;], &quot;genres&quot;: [&quot;Action&quot;, &quot;Adventure&quot;, &quot;Fantasy&quot;, &quot;Sci-Fi&quot;]}, &quot;year&quot;: 2016, &quot;title&quot;: &quot;Avatar 2&quot;}</span>
<span class="linenos" data-linenos="35 "></span>    <span class="k">for</span> <span class="n">genero</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">][</span><span class="s1">&#39;genres&#39;</span><span class="p">]:</span>
<span class="linenos" data-linenos="36 "></span>        <span class="nb">print</span><span class="p">(</span><span class="n">genero</span><span class="p">)</span>
<span class="linenos" data-linenos="37 "></span>
<span class="linenos" data-linenos="38 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----Películas de 2016 cuyo título empieza desde A hasta L con PartiQL&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="39 "></span><span class="n">clientDDB</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="40 "></span><span class="n">consulta</span> <span class="o">=</span> <span class="s1">&#39;SELECT year, title, info.genres, info.actors[0] FROM SeveroPeliculas WHERE year = ? AND title between ? and ?&#39;</span>
<span class="linenos" data-linenos="41 "></span><span class="n">resp</span> <span class="o">=</span> <span class="n">clientDDB</span><span class="o">.</span><span class="n">execute_statement</span><span class="p">(</span><span class="n">Statement</span><span class="o">=</span><span class="n">consulta</span><span class="p">,</span>
<span class="linenos" data-linenos="42 "></span>                                <span class="n">Parameters</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">anyo</span><span class="p">)},</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">letraInicial</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">letraFinal</span><span class="p">}])</span>
<span class="linenos" data-linenos="43 "></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">]:</span>
<span class="linenos" data-linenos="44 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="linenos" data-linenos="45 "></span>    <span class="c1"># [{&#39;year&#39;: {&#39;N&#39;: &#39;2016&#39;}, &#39;title&#39;: {&#39;S&#39;: &#39;Avatar 2&#39;}, &#39;actors[0]&#39;: {&#39;S&#39;: &#39;Zoe Saldana&#39;}, &#39;genres&#39;: {&#39;L&#39;: [{&#39;S&#39;: &#39;Action&#39;}, {&#39;S&#39;: &#39;Adventure&#39;}, {&#39;S&#39;: &#39;Fantasy&#39;}, {&#39;S&#39;: &#39;Sci-Fi&#39;}]}}]</span>
<span class="linenos" data-linenos="46 "></span>    <span class="k">for</span> <span class="n">genero</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;genres&#39;</span><span class="p">][</span><span class="s1">&#39;L&#39;</span><span class="p">]:</span>
<span class="linenos" data-linenos="47 "></span>        <span class="nb">print</span><span class="p">(</span><span class="n">genero</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">])</span>
</code></pre></div>
</div>
</div>
</div>
<p>La clase <code>DecimalEncoder</code> se utiliza para transformar los campos Decimal que utiliza DynamoDB para almacenar contenido númerico a tipo entero o flotante según necesite.</p>
<h3 id="full-scan">Full scan<a class="headerlink" href="#full-scan" title="Permanent link">&para;</a></h3>
<p>Cuando en <em>PartiQL</em> no le indicamos en la condición una expresión que busque por una de las claves, se realizará un full scan sobre toda la tabla, lo que puede implicar unos costes inesperados, tanto económicos como a nivel rendimiento provisionado.</p>
<p>El método <code>scan</code> lee cada elemento de la tabla y devuelve todos los datos de la tabla. Se le puede pasar una <code>filter_expression</code> opcional para que sólo devuelva los elementos que cumplan el criterio. Sin embargo, el filtrado se aplica tras escanear toda la tabla.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:1"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">Ejemplo scan</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">import</span> <span class="nn">decimal</span>
<span class="linenos" data-linenos=" 4 "></span><span class="kn">from</span> <span class="nn">boto3.dynamodb.conditions</span> <span class="kn">import</span> <span class="n">Key</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="k">class</span> <span class="nc">DecimalEncoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">):</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="k">if</span> <span class="n">o</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos" data-linenos="10 "></span>                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="linenos" data-linenos="11 "></span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos" data-linenos="12 "></span>                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="linenos" data-linenos="13 "></span>        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DecimalEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="16 "></span><span class="n">tabla</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;SeveroPeliculas&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="17 "></span>
<span class="linenos" data-linenos="18 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----Películas de sobresaliente mediante full scan&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="19 "></span><span class="c1"># Escaneo y filtrado</span>
<span class="linenos" data-linenos="20 "></span><span class="n">fe</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="s1">&#39;info.rating&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="linenos" data-linenos="21 "></span><span class="n">pe</span> <span class="o">=</span> <span class="s2">&quot;#yr, title, info.rating&quot;</span>
<span class="linenos" data-linenos="22 "></span><span class="n">ean</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;#yr&quot;</span><span class="p">:</span> <span class="s2">&quot;year&quot;</span><span class="p">}</span>
<span class="linenos" data-linenos="23 "></span><span class="n">resp</span> <span class="o">=</span> <span class="n">tabla</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
<span class="linenos" data-linenos="24 "></span>    <span class="n">FilterExpression</span><span class="o">=</span><span class="n">fe</span><span class="p">,</span>
<span class="linenos" data-linenos="25 "></span>    <span class="n">ProjectionExpression</span><span class="o">=</span><span class="n">pe</span><span class="p">,</span>
<span class="linenos" data-linenos="26 "></span>    <span class="n">ExpressionAttributeNames</span><span class="o">=</span><span class="n">ean</span>
<span class="linenos" data-linenos="27 "></span><span class="p">)</span>
<span class="linenos" data-linenos="28 "></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">]:</span>
<span class="linenos" data-linenos="29 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">DecimalEncoder</span><span class="p">))</span>
</code></pre></div>
<div class="tabbed-set tabbed-alternate" data-tabs="9:1"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="__tabbed_9_1">Full scan con PartiQL</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos="2 "></span><span class="kn">from</span> <span class="nn">boto3.dynamodb.conditions</span> <span class="kn">import</span> <span class="n">Key</span>
<span class="linenos" data-linenos="3 "></span>
<span class="linenos" data-linenos="4 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----Películas de 2016 con PartiQL&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="5 "></span><span class="n">clientDDB</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="6 "></span><span class="n">resp</span> <span class="o">=</span> <span class="n">clientDDB</span><span class="o">.</span><span class="n">execute_statement</span><span class="p">(</span>
<span class="linenos" data-linenos="7 "></span>    <span class="n">Statement</span><span class="o">=</span><span class="s2">&quot;SELECT title, year, info.rating FROM SeveroPeliculas WHERE info.rating &gt;= 9&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="8 "></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">]:</span>
<span class="linenos" data-linenos="9 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">][</span><span class="s1">&#39;S&#39;</span><span class="p">])</span>
</code></pre></div>
<h2 id="caso-de-uso-4-de-s3-a-dynamodb">Caso de uso 4 - De S3 a DynamoDB<a class="headerlink" href="#caso-de-uso-4-de-s3-a-dynamodb" title="Permanent link">&para;</a></h2>
<p>En este caso, vamos a coger datos de películas de un dataset público disponible en <a href="https://www.kaggle.com/sankha1998/tmdb-top-10000-popular-movies-dataset">https://www.kaggle.com/sankha1998/tmdb-top-10000-popular-movies-dataset</a></p>
<p>El contenido del dataset es similar a:</p>
<div class="highlight"><span class="filename">TMDb_updated.CSV</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span>,title,overview,original_language,vote_count,vote_average
<span class="linenos" data-linenos="2 "></span>0,Ad Astra,&quot;The near future...&quot;,en,2853,5.9
<span class="linenos" data-linenos="3 "></span>1,Bloodshot,&quot;After he ...&quot;,en,1349,7.2
<span class="linenos" data-linenos="4 "></span>2,Bad Boys for Life,&quot;Marcus and Mike ...&quot;,en,2530,7.1
</code></pre></div>
<p>Una vez descargado <a href="../recursos/TMDb_updated.CSV">TMDb_updated.CSV</a>, vamos a cargar la información en S3 dentro del bucket. Para este caso, en vez de cargar todos los datos desde el dataset en nuestra tabla NoSQL, vamos a meter en DynamoDB el título, la nota media y la trama siempre y cuando hayan recibido al menos 10.000 votos.</p>
<h3 id="s3select">S3Select<a class="headerlink" href="#s3select" title="Permanent link">&para;</a></h3>
<p>Para realizar esta consulta desde Python para poder automatizar el proceso ETL utilizaremos S3Select para recuperar el subconjunto de los datos.</p>
<div class="admonition info">
<p class="admonition-title">S3Select vs AWS Athena</p>
<p>Este tipo de procesamiento es más cómodo realizarlo mediante AWS Athena, el cual sí que permite realizar <em>join</em> entre diferentes datasets. S3Select sólo permite trabajar con una única tabla.</p>
</div>
<p>Para ello, mediante S3Select ejecutaremos la consulta <code>SELECT s.title, s.overview, s.vote_count, s.vote_average FROM s3object s WHERE cast(s.vote_count as int)&gt; 10000</code> y almacenaremos el resultado en un nuevo CSV dentro del mismo bucket:</p>
<div class="highlight"><span class="filename">s3select.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="c1"># 1.- Realizamos la consulta mediante S3Select</span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">resp</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">select_object_content</span><span class="p">(</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="n">Bucket</span><span class="o">=</span><span class="s1">&#39;s3severo2122python&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="n">Key</span><span class="o">=</span><span class="s1">&#39;TMDb_updated.CSV&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="n">ExpressionType</span><span class="o">=</span><span class="s1">&#39;SQL&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>    <span class="n">Expression</span><span class="o">=</span><span class="s2">&quot;SELECT s.title, s.overview, s.vote_count, s.vote_average FROM s3object s WHERE cast(s.vote_count as int)&gt; 10000&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="11 "></span>    <span class="n">InputSerialization</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;CSV&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;FileHeaderInfo&quot;</span><span class="p">:</span> <span class="s2">&quot;USE&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="12 "></span>                                <span class="s1">&#39;AllowQuotedRecordDelimiter&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
<span class="linenos" data-linenos="13 "></span>                        <span class="s1">&#39;CompressionType&#39;</span><span class="p">:</span> <span class="s1">&#39;NONE&#39;</span><span class="p">},</span>
<span class="linenos" data-linenos="14 "></span>    <span class="n">OutputSerialization</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;CSV&#39;</span><span class="p">:</span> <span class="p">{}},</span>
<span class="linenos" data-linenos="15 "></span><span class="p">)</span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span>
<span class="linenos" data-linenos="18 "></span><span class="c1"># 2.- Unimos los datos que vamos recibiendo en streaming</span>
<span class="linenos" data-linenos="19 "></span><span class="n">registros</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;title, overview, vote_count, vote_average</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
<span class="linenos" data-linenos="20 "></span><span class="k">for</span> <span class="n">evento</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;Payload&#39;</span><span class="p">]:</span>
<span class="linenos" data-linenos="21 "></span>    <span class="k">if</span> <span class="s1">&#39;Records&#39;</span> <span class="ow">in</span> <span class="n">evento</span><span class="p">:</span>
<span class="linenos" data-linenos="22 "></span>        <span class="n">registros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evento</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">][</span><span class="s1">&#39;Payload&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<span class="linenos" data-linenos="23 "></span>
<span class="linenos" data-linenos="24 "></span><span class="c1"># 3.- Generamos el contenido en un String</span>
<span class="linenos" data-linenos="25 "></span><span class="n">file_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">registros</span><span class="p">)</span>
<span class="linenos" data-linenos="26 "></span>
<span class="linenos" data-linenos="27 "></span><span class="c1"># 4.- Creamos un nuevo objeto en S3</span>
<span class="linenos" data-linenos="28 "></span><span class="n">s3</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span><span class="n">Body</span><span class="o">=</span><span class="n">file_str</span><span class="p">,</span> <span class="n">Bucket</span><span class="o">=</span><span class="s1">&#39;s3severo2122python&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="29 "></span>              <span class="n">Key</span><span class="o">=</span><span class="s2">&quot;TMDb_filtered.CSV&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="de-s3-a-dynamodb">De S3 a DynamoDB<a class="headerlink" href="#de-s3-a-dynamodb" title="Permanent link">&para;</a></h3>
<p>Una vez creado el fichero en S3, vamos cargar los datos en DynamoDB. Como el dataset no contenía la fecha de la película, en nuestro caso le vamos a poner a todas las películas que son del 2022:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="c1"># 1.- Leemos el fichero desde S3 y lo metemos en un DataFrame</span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">s3c</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">bucketNombre</span> <span class="o">=</span> <span class="s2">&quot;s3severo2122python&quot;</span>
<span class="linenos" data-linenos=" 8 "></span><span class="n">ficheroNombre</span> <span class="o">=</span> <span class="s2">&quot;TMDb_filtered.CSV&quot;</span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">response</span> <span class="o">=</span> <span class="n">s3c</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucketNombre</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">ficheroNombre</span><span class="p">)</span>
<span class="linenos" data-linenos="10 "></span><span class="n">movies_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Body&#39;</span><span class="p">],</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="c1"># 2.- Nos conectamos a DynamoDB</span>
<span class="linenos" data-linenos="13 "></span><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="14 "></span><span class="n">tabla</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;SeveroPeliculas&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="15 "></span>
<span class="linenos" data-linenos="16 "></span><span class="c1"># 3.- Lo metemos en DynamoDB mediante un batch</span>
<span class="linenos" data-linenos="17 "></span><span class="k">with</span> <span class="n">tabla</span><span class="o">.</span><span class="n">batch_writer</span><span class="p">()</span> <span class="k">as</span> <span class="n">batch</span><span class="p">:</span>
<span class="linenos" data-linenos="18 "></span>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fila</span> <span class="ow">in</span> <span class="n">movies_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<span class="linenos" data-linenos="19 "></span>        <span class="n">Item</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos" data-linenos="20 "></span>            <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="mi">2022</span><span class="p">,</span>
<span class="linenos" data-linenos="21 "></span>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">fila</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]),</span>
<span class="linenos" data-linenos="22 "></span>            <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="23 "></span>                <span class="s1">&#39;plot&#39;</span> <span class="p">:</span> <span class="n">fila</span><span class="p">[</span><span class="s1">&#39;overview&#39;</span><span class="p">],</span>
<span class="linenos" data-linenos="24 "></span>                <span class="s1">&#39;rating&#39;</span> <span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">fila</span><span class="p">[</span><span class="s1">&#39;vote_average&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1.00&#39;</span><span class="p">))</span>
<span class="linenos" data-linenos="25 "></span>            <span class="p">}</span>
<span class="linenos" data-linenos="26 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="27 "></span>        <span class="n">batch</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">Item</span><span class="o">=</span><span class="n">Item</span><span class="p">)</span>
</code></pre></div>
<h2 id="caso-de-uso-5-desde-rds">Caso de uso 5 - Desde RDS<a class="headerlink" href="#caso-de-uso-5-desde-rds" title="Permanent link">&para;</a></h2>
<div class="admonition tip">
<p class="admonition-title">Preparación MariaBD</p>
<p>Para estos actividades y futuras sesiones, vamos a utilizar una base de datos (<em>retail_db</em>) que contiene información sobre un comercio (clientes, productos, pedidos, etc...).</p>
<p>Para ello, descargaremos el archivo <a href="../recursos/create_db.sql">create_db.sql</a> con las sentencias para crear la base de datos y los datos como instrucciones SQL.</p>
<p>Tras ello, bien sea mediante DBeaver o si nos conectamos a MariaDB (<code>mariadb -u iabd -p</code>) desde la misma carpeta que hemos descargado el archivo, ejecutaremos los siguientes comando:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="k">create</span> <span class="k">database</span> <span class="n">retail_db</span><span class="p">;</span>
<span class="linenos" data-linenos="2 "></span><span class="n">use</span> <span class="n">retail_db</span><span class="p">;</span>
<span class="linenos" data-linenos="3 "></span><span class="k">source</span> <span class="n">create_db</span><span class="p">.</span><span class="k">sql</span><span class="p">;</span>
<span class="linenos" data-linenos="4 "></span><span class="k">show</span> <span class="n">tables</span><span class="p">;</span>
</code></pre></div>
</div>
<p>Vamos a utilizar la instancia de base de datos iabd que tenemos en RDS con la base de datos <code>retail_db</code>.</p>
<h3 id="mariadbmysql-y-python">MariaDB/MySQL y Python<a class="headerlink" href="#mariadbmysql-y-python" title="Permanent link">&para;</a></h3>
<p>Para acceder a la base de datos desde Python necesitamos instalar la librería correspondiente:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>pip3 install mariadb
<span class="linenos" data-linenos="2 "></span>pip3 install mysql-connector-python
</code></pre></div>
<p>Todo el código a continuación se basa en <em>MariaDB</em> como sistema gestor de base de datos. Si queremos conectarnos, debemos indicar los datos de conexion:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">mariadb</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">try</span><span class="p">:</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="n">conn</span> <span class="o">=</span> <span class="n">mariadb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
<span class="linenos" data-linenos=" 6 "></span>        <span class="n">user</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span>        <span class="n">password</span><span class="o">=</span><span class="s2">&quot;adminadmin&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="n">host</span><span class="o">=</span><span class="s2">&quot;iabd.cllw9xnmy9av.us-east-1.rds.amazonaws.com&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>        <span class="n">port</span><span class="o">=</span><span class="mi">3306</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>        <span class="n">database</span><span class="o">=</span><span class="s2">&quot;retail_db&quot;</span>
<span class="linenos" data-linenos="11 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="12 "></span><span class="k">except</span> <span class="n">mariadb</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos" data-linenos="13 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error conectando a MariaD: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="14 "></span>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="15 "></span>
<span class="linenos" data-linenos="16 "></span><span class="c1"># Obtenemos el cursor</span>
<span class="linenos" data-linenos="17 "></span><span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</code></pre></div>
<p>Una vez nos hemos conectado y tenemos abierto un cursor, ya podemos hacer consultas y recuperar datos.</p>
<p>Por ejemplo, para recuperar toda la información de los clientes almacenada en la tabla <code>customers</code>:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select * from customers&quot;</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">resultado</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchAll</span><span class="p">()</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="c1"># Cerramos el cursor y la conexión</span>
<span class="linenos" data-linenos=" 6 "></span><span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1"># Mostramos el resultado</span>
<span class="linenos" data-linenos="10 "></span><span class="nb">print</span><span class="p">(</span><span class="n">resultado</span><span class="p">)</span>
</code></pre></div>
<h3 id="de-rds-a-s3">De RDS a S3<a class="headerlink" href="#de-rds-a-s3" title="Permanent link">&para;</a></h3>
<p>Vamos a realizar otro ejemplo sencillo que recupere el nombre, apellido y email de los clientes mediante una consulta que reibe un parámetro:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">mariadb</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos" data-linenos=" 4 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="k">try</span><span class="p">:</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="n">conn</span> <span class="o">=</span> <span class="n">mariadb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="n">user</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>        <span class="n">password</span><span class="o">=</span><span class="s2">&quot;adminadmin&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>        <span class="n">host</span><span class="o">=</span><span class="s2">&quot;iabd.cllw9xnmy9av.us-east-1.rds.amazonaws.com&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="11 "></span>        <span class="n">port</span><span class="o">=</span><span class="mi">3306</span><span class="p">,</span>
<span class="linenos" data-linenos="12 "></span>        <span class="n">database</span><span class="o">=</span><span class="s2">&quot;retail_db&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="13 "></span><span class="k">except</span> <span class="n">mariadb</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos" data-linenos="14 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error conectando a MariaDB: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span><span class="n">ciudad</span> <span class="o">=</span> <span class="s2">&quot;Brownsville&quot;</span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span><span class="c1"># Obtenemos el cursor</span>
<span class="linenos" data-linenos="20 "></span><span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos" data-linenos="21 "></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select customer_fname, customer_lname, customer_zipcode from customers where customer_city=?&quot;</span>
<span class="linenos" data-linenos="22 "></span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">(</span><span class="n">ciudad</span><span class="p">,</span> <span class="p">))</span>
<span class="linenos" data-linenos="23 "></span>
<span class="linenos" data-linenos="24 "></span><span class="c1"># Generamos un JSON con los datos</span>
<span class="linenos" data-linenos="25 "></span><span class="n">row_headers</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">description</span><span class="p">]</span> 
<span class="linenos" data-linenos="26 "></span><span class="n">clientes</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos" data-linenos="27 "></span><span class="n">json_data</span><span class="o">=</span><span class="p">[]</span>
<span class="linenos" data-linenos="28 "></span><span class="k">for</span> <span class="n">cliente</span> <span class="ow">in</span> <span class="n">clientes</span><span class="p">:</span>
<span class="linenos" data-linenos="29 "></span>    <span class="n">json_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">row_headers</span><span class="p">,</span><span class="n">cliente</span><span class="p">)))</span>
<span class="linenos" data-linenos="30 "></span>
<span class="linenos" data-linenos="31 "></span><span class="c1"># Cerramos el cursor y la conexión</span>
<span class="linenos" data-linenos="32 "></span><span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos" data-linenos="33 "></span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos" data-linenos="34 "></span>
<span class="linenos" data-linenos="35 "></span><span class="c1"># Persistimos el JSON en S3</span>
<span class="linenos" data-linenos="36 "></span><span class="n">s3r</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="37 "></span><span class="nb">object</span> <span class="o">=</span> <span class="n">s3r</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="s1">&#39;s3severo2122python&#39;</span><span class="p">,</span> <span class="s1">&#39;clientesRDS.json&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="38 "></span><span class="nb">object</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">Body</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_data</span><span class="p">))</span>
</code></pre></div>
<h3 id="de-rds-a-dynamodb">De RDS a DynamoDB<a class="headerlink" href="#de-rds-a-dynamodb" title="Permanent link">&para;</a></h3>
<p>Para este caso de uso, vamos a crear una nueva tabla en DynamoDB a la que llamaremos <code>SeveroClientes</code> y le pondremos como clave de particionado el campo <code>Id</code> de tipo numérico y como clave de ordenamiento el <code>Zip</code> de tipo texto.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/05ddSeveroClientes.png">
    <figcaption>Creación de la tabla SeveroClientes</figcaption>
</figure>

<p>Vamos a modificar el ejemplo anterior para que, una vez recuperado los datos de la base de datos, los almacene directamente en DynamoDB:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">mariadb</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="k">try</span><span class="p">:</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="n">conn</span> <span class="o">=</span> <span class="n">mariadb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
<span class="linenos" data-linenos=" 7 "></span>        <span class="n">user</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="n">password</span><span class="o">=</span><span class="s2">&quot;adminadmin&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>        <span class="n">host</span><span class="o">=</span><span class="s2">&quot;iabd.cllw9xnmy9av.us-east-1.rds.amazonaws.com&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>        <span class="n">port</span><span class="o">=</span><span class="mi">3306</span><span class="p">,</span>
<span class="linenos" data-linenos="11 "></span>        <span class="n">database</span><span class="o">=</span><span class="s2">&quot;retail_db&quot;</span>
<span class="linenos" data-linenos="12 "></span>    <span class="p">)</span>
<span class="linenos" data-linenos="13 "></span><span class="k">except</span> <span class="n">mariadb</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos" data-linenos="14 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error conectando a MariaDB: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span><span class="n">ciudad</span> <span class="o">=</span> <span class="s2">&quot;Brownsville&quot;</span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span><span class="c1"># Obtenemos el cursor</span>
<span class="linenos" data-linenos="20 "></span><span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos" data-linenos="21 "></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select customer_id, customer_fname, customer_lname, customer_zipcode from customers where customer_city=?&quot;</span>
<span class="linenos" data-linenos="22 "></span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">(</span><span class="n">ciudad</span><span class="p">,</span> <span class="p">))</span>
<span class="linenos" data-linenos="23 "></span>
<span class="linenos" data-linenos="24 "></span><span class="c1"># Recorremos el cursor e insertamos en DynamoDB</span>
<span class="linenos" data-linenos="25 "></span><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="26 "></span><span class="n">tabla</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;SeveroClientes&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="27 "></span><span class="k">with</span> <span class="n">tabla</span><span class="o">.</span><span class="n">batch_writer</span><span class="p">()</span> <span class="k">as</span> <span class="n">batch</span><span class="p">:</span>
<span class="linenos" data-linenos="28 "></span>    <span class="k">for</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">customer_fname</span><span class="p">,</span> <span class="n">customer_lname</span><span class="p">,</span> <span class="n">customer_zipcode</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span> 
<span class="linenos" data-linenos="29 "></span>        <span class="n">Item</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos" data-linenos="30 "></span>            <span class="s1">&#39;Id&#39;</span><span class="p">:</span> <span class="n">customer_id</span><span class="p">,</span>
<span class="linenos" data-linenos="31 "></span>            <span class="s1">&#39;Zip&#39;</span><span class="p">:</span> <span class="n">customer_zipcode</span><span class="p">,</span>
<span class="linenos" data-linenos="32 "></span>            <span class="s1">&#39;Nombre&#39;</span><span class="p">:</span> <span class="n">customer_fname</span><span class="p">,</span>
<span class="linenos" data-linenos="33 "></span>            <span class="s1">&#39;Apellidos&#39;</span><span class="p">:</span> <span class="n">customer_lname</span><span class="p">,</span>
<span class="linenos" data-linenos="34 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="35 "></span>    <span class="n">batch</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">Item</span><span class="o">=</span><span class="n">Item</span><span class="p">)</span>
<span class="linenos" data-linenos="36 "></span>
<span class="linenos" data-linenos="37 "></span><span class="c1"># Cerramos el cursor y la conexión</span>
<span class="linenos" data-linenos="38 "></span><span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos" data-linenos="39 "></span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Bases de datos y Pandas</p>
<p>Si estás interesado en colocar dentro de Pandas los datos que recuperas desde una base de datos, es muy cómodo utilizar <a href="https://www.sqlalchemy.org/">SQLAlchemy</a> el cual ofrece una capa por encima de los drivers (además de ofrecer un framework ORM).</p>
<p>Un fragmento de código que utiliza Pandas y SQLAlchmy sería similar a:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="linenos" data-linenos="2 "></span><span class="kn">import</span> <span class="nn">pymysql</span>
<span class="linenos" data-linenos="3 "></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="linenos" data-linenos="4 "></span>
<span class="linenos" data-linenos="5 "></span><span class="n">sqlEngine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;mysql+pymysql://iabd:@127.0.0.1&#39;</span><span class="p">,</span> <span class="n">pool_recycle</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
<span class="linenos" data-linenos="6 "></span><span class="n">dbConnection</span> <span class="o">=</span> <span class="n">sqlEngine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos" data-linenos="7 "></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;select * from retail_db.customers&quot;</span><span class="p">,</span> <span class="n">dbConnection</span><span class="p">);</span>
</code></pre></div>
</div>
<h2 id="caso-de-uso-6-aws-lambda">Caso de uso 6 - AWS Lambda<a class="headerlink" href="#caso-de-uso-6-aws-lambda" title="Permanent link">&para;</a></h2>
<p>En este caso de uso, vamos a realizar los casos de uso 4 y 5 mediante AWS Lambda, de manera que accedamos a S3, RDS y DynamoDB mediante funciones serverless.</p>
<p>Vamos a empezar con el caso <a href="ingesta05python.html#de-s3-a-dynamodb">4.2 De S3 a DynamoDB</a>. Para ello, nos vamos a crear una función que se ejecutará automáticamente cada vez que se inserte en el bucket <code>s3severo2122python</code> el objeto <code>TMDb_filtered.csv</code>. Si repasamos el caso de uso, el objetivo es cargar los datos de dicho CSV a la tabla <code>SeveroPeliculas</code> de DynamoDB.</p>
<p>Así pues, el primer paso, es acceder a AWS Lambda y crear una nueva función desde cero con soporte para Python 3.9 y x86_64:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 4 "></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="linenos" data-linenos=" 5 "></span><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading function&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="10 "></span>
<span class="linenos" data-linenos="11 "></span><span class="n">bucketNombre</span> <span class="o">=</span> <span class="s2">&quot;s3severo2122python&quot;</span>
<span class="linenos" data-linenos="12 "></span><span class="n">ficheroNombre</span> <span class="o">=</span> <span class="s2">&quot;TMDb_filtered.CSV&quot;</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="linenos" data-linenos="15 "></span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Received event: &quot;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span>    <span class="c1"># Obtenemos el bucket y el objeto desde el evento</span>
<span class="linenos" data-linenos="18 "></span>    <span class="n">bucket</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;s3&#39;</span><span class="p">][</span><span class="s1">&#39;bucket&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="linenos" data-linenos="19 "></span>    <span class="n">key</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote_plus</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;s3&#39;</span><span class="p">][</span><span class="s1">&#39;object&#39;</span><span class="p">][</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="20 "></span>
<span class="linenos" data-linenos="21 "></span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos" data-linenos="22 "></span>        <span class="k">if</span> <span class="n">bucket</span> <span class="o">==</span> <span class="n">bucketNombre</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ficheroNombre</span><span class="p">:</span>
<span class="linenos" data-linenos="23 "></span>
<span class="linenos" data-linenos="24 "></span>            <span class="c1"># 1.- Leemos el fichero desde S3 y lo metemos en un DataFrame</span>
<span class="linenos" data-linenos="25 "></span>            <span class="n">response</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucketNombre</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">ficheroNombre</span><span class="p">)</span>
<span class="linenos" data-linenos="26 "></span>            <span class="n">movies_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Body&#39;</span><span class="p">],</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="27 "></span>
<span class="linenos" data-linenos="28 "></span>            <span class="c1"># 2.- Nos conectamos a DynamoDB</span>
<span class="linenos" data-linenos="29 "></span>            <span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="30 "></span>            <span class="n">tabla</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;SeveroPeliculas&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="31 "></span>
<span class="linenos" data-linenos="32 "></span>            <span class="c1"># 3.- Lo metemos en DynamoDB mediante un batch</span>
<span class="linenos" data-linenos="33 "></span>            <span class="k">with</span> <span class="n">tabla</span><span class="o">.</span><span class="n">batch_writer</span><span class="p">()</span> <span class="k">as</span> <span class="n">batch</span><span class="p">:</span>
<span class="linenos" data-linenos="34 "></span>                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fila</span> <span class="ow">in</span> <span class="n">movies_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<span class="linenos" data-linenos="35 "></span>                    <span class="n">Item</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos" data-linenos="36 "></span>                        <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="mi">2022</span><span class="p">,</span>
<span class="linenos" data-linenos="37 "></span>                        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">fila</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]),</span>
<span class="linenos" data-linenos="38 "></span>                        <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="39 "></span>                            <span class="s1">&#39;plot&#39;</span> <span class="p">:</span> <span class="n">fila</span><span class="p">[</span><span class="s1">&#39;overview&#39;</span><span class="p">],</span>
<span class="linenos" data-linenos="40 "></span>                            <span class="s1">&#39;rating&#39;</span> <span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">fila</span><span class="p">[</span><span class="s1">&#39;vote_average&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1.00&#39;</span><span class="p">))</span>
<span class="linenos" data-linenos="41 "></span>                        <span class="p">}</span>
<span class="linenos" data-linenos="42 "></span>                    <span class="p">}</span>
<span class="linenos" data-linenos="43 "></span>                    <span class="n">batch</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">Item</span><span class="o">=</span><span class="n">Item</span><span class="p">)</span>
<span class="linenos" data-linenos="44 "></span>
<span class="linenos" data-linenos="45 "></span>            <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;ContentType&#39;</span><span class="p">]</span>
<span class="linenos" data-linenos="46 "></span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos" data-linenos="47 "></span>        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="linenos" data-linenos="48 "></span>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error getting object </span><span class="si">{}</span><span class="s1"> from bucket </span><span class="si">{}</span><span class="s1">. Make sure they exist and your bucket is in the same region as this function.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">bucket</span><span class="p">))</span>
<span class="linenos" data-linenos="49 "></span>        <span class="k">raise</span> <span class="n">e</span>
</code></pre></div>
<p>Para poder probar nuestra función, vamos a crear un nuevo evento con el siguiente contenido (el cual hemos creado a partir de la plantilla de <code>s3-put</code>):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span>  <span class="nt">&quot;Records&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 4 "></span>      <span class="nt">&quot;eventVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span>      <span class="nt">&quot;eventSource&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:s3&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span>      <span class="nt">&quot;awsRegion&quot;</span><span class="p">:</span> <span class="s2">&quot;us-east-1&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span>      <span class="nt">&quot;eventTime&quot;</span><span class="p">:</span> <span class="s2">&quot;1970-01-01T00:00:00.000Z&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>      <span class="nt">&quot;eventName&quot;</span><span class="p">:</span> <span class="s2">&quot;ObjectCreated:Put&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>      <span class="nt">&quot;userIdentity&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="10 "></span>        <span class="nt">&quot;principalId&quot;</span><span class="p">:</span> <span class="s2">&quot;EXAMPLE&quot;</span>
<span class="linenos" data-linenos="11 "></span>      <span class="p">},</span>
<span class="linenos" data-linenos="12 "></span>      <span class="nt">&quot;requestParameters&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="13 "></span>        <span class="nt">&quot;sourceIPAddress&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span>
<span class="linenos" data-linenos="14 "></span>      <span class="p">},</span>
<span class="linenos" data-linenos="15 "></span>      <span class="nt">&quot;responseElements&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="16 "></span>        <span class="nt">&quot;x-amz-request-id&quot;</span><span class="p">:</span> <span class="s2">&quot;EXAMPLE123456789&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="17 "></span>        <span class="nt">&quot;x-amz-id-2&quot;</span><span class="p">:</span> <span class="s2">&quot;EXAMPLE123/5678abcdefghijklambdaisawesome/mnopqrstuvwxyzABCDEFGH&quot;</span>
<span class="linenos" data-linenos="18 "></span>      <span class="p">},</span>
<span class="linenos" data-linenos="19 "></span>      <span class="nt">&quot;s3&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="20 "></span>        <span class="nt">&quot;s3SchemaVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="21 "></span>        <span class="nt">&quot;configurationId&quot;</span><span class="p">:</span> <span class="s2">&quot;testConfigRule&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="22 "></span>        <span class="nt">&quot;bucket&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="23 "></span>          <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;s3severo2122python&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="24 "></span>          <span class="nt">&quot;ownerIdentity&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="25 "></span>            <span class="nt">&quot;principalId&quot;</span><span class="p">:</span> <span class="s2">&quot;EXAMPLE&quot;</span>
<span class="linenos" data-linenos="26 "></span>          <span class="p">},</span>
<span class="linenos" data-linenos="27 "></span>          <span class="nt">&quot;arn&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:s3:::s3severo2122python&quot;</span>
<span class="linenos" data-linenos="28 "></span>        <span class="p">},</span>
<span class="linenos" data-linenos="29 "></span>        <span class="nt">&quot;object&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos" data-linenos="30 "></span>          <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;TMDb_filtered.CSV&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="31 "></span>          <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
<span class="linenos" data-linenos="32 "></span>          <span class="nt">&quot;eTag&quot;</span><span class="p">:</span> <span class="s2">&quot;0123456789abcdef0123456789abcdef&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="33 "></span>          <span class="nt">&quot;sequencer&quot;</span><span class="p">:</span> <span class="s2">&quot;0A1B2C3D4E5F678901&quot;</span>
<span class="linenos" data-linenos="34 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="35 "></span>      <span class="p">}</span>
<span class="linenos" data-linenos="36 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="37 "></span>  <span class="p">]</span>
<span class="linenos" data-linenos="38 "></span><span class="p">}</span>
</code></pre></div>
<p>Si ahora desplegamos e intentamos probar la función, nos dará error ya que no encuentra la librería de <em>Pandas</em>. Para que funcione, necesitamos añadirla como una capa de AWS Lambda. Para ello, en la parte inferior de la pantalla, tenemos la opción de añadir una nueva capa. En nuestro caso, vamos a añadirla a través de un ARN:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>arn:aws:lambda:us-east-1:770693421928:layer:Klayers-p39-pandas:1
</code></pre></div>
<figure style="align: center;">
    <img src="../imagenes/etl/05lambda-capa.png">
    <figcaption>Capa con Pandas en AWS Lambda</figcaption>
</figure>

<p>Ahora sí que podemos ejecutar nuestra función y comprobar que todo funciona correctamente.</p>
<h3 id="desencadenador">Desencadenador<a class="headerlink" href="#desencadenador" title="Permanent link">&para;</a></h3>
<p>El siguiente paso es conectar un desencadenador para que automáticamente se lance la función. Para ello, desde el gráfico con el esquema de la función, sobre el botón de <code>+Agregar desencadenador</code>, configuramos la carga de objetos S3 en nuestro repositorio:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/05lambda-desencadenador.png">
    <figcaption>Desencadenador en AWS Lambda</figcaption>
</figure>

<p>Una vez que ya tenemos la función desplegada y hemos comprobado que funciona correctamente, podemos probar primero a borrar y volver a crear la tabla de SeveroPeliculas y a continuación, ejecutar el caso de uso 4.1:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="10:3"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><input id="__tabbed_10_2" name="__tabbed_10" type="radio" /><input id="__tabbed_10_3" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="__tabbed_10_1">Borrando SeveroPeliculas</label><label for="__tabbed_10_2">Creando SeveroPeliculas</label><label for="__tabbed_10_3">Creando TMDB_filtered.CSV</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">borrarTablaDDB.py</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos="2 "></span>
<span class="linenos" data-linenos="3 "></span><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="4 "></span>
<span class="linenos" data-linenos="5 "></span><span class="n">tabla</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;SeveroPeliculas&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="6 "></span><span class="n">tabla</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="linenos" data-linenos="7 "></span>
<span class="linenos" data-linenos="8 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estado:&quot;</span><span class="p">,</span> <span class="n">tabla</span><span class="o">.</span><span class="n">table_status</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">crearTablaDDB.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">tabla</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="n">TableName</span><span class="o">=</span><span class="s1">&#39;SeveroPeliculas&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="n">KeySchema</span><span class="o">=</span><span class="p">[</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="p">{</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="s1">&#39;AttributeName&#39;</span><span class="p">:</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>            <span class="s1">&#39;KeyType&#39;</span><span class="p">:</span> <span class="s1">&#39;HASH&#39;</span>         <span class="c1"># clave principal</span>
<span class="linenos" data-linenos="11 "></span>        <span class="p">},</span>
<span class="linenos" data-linenos="12 "></span>        <span class="p">{</span>
<span class="linenos" data-linenos="13 "></span>            <span class="s1">&#39;AttributeName&#39;</span><span class="p">:</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="14 "></span>            <span class="s1">&#39;KeyType&#39;</span><span class="p">:</span> <span class="s1">&#39;RANGE&#39;</span>        <span class="c1"># clave ordenacion</span>
<span class="linenos" data-linenos="15 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="16 "></span>    <span class="p">],</span>
<span class="linenos" data-linenos="17 "></span>    <span class="n">AttributeDefinitions</span><span class="o">=</span><span class="p">[</span>
<span class="linenos" data-linenos="18 "></span>        <span class="p">{</span>
<span class="linenos" data-linenos="19 "></span>            <span class="s1">&#39;AttributeName&#39;</span><span class="p">:</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="20 "></span>            <span class="s1">&#39;AttributeType&#39;</span><span class="p">:</span> <span class="s1">&#39;N&#39;</span>
<span class="linenos" data-linenos="21 "></span>        <span class="p">},</span>
<span class="linenos" data-linenos="22 "></span>        <span class="p">{</span>
<span class="linenos" data-linenos="23 "></span>            <span class="s1">&#39;AttributeName&#39;</span><span class="p">:</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="24 "></span>            <span class="s1">&#39;AttributeType&#39;</span><span class="p">:</span> <span class="s1">&#39;S&#39;</span>
<span class="linenos" data-linenos="25 "></span>        <span class="p">},</span>
<span class="linenos" data-linenos="26 "></span>    <span class="p">],</span>
<span class="linenos" data-linenos="27 "></span>    <span class="n">ProvisionedThroughput</span><span class="o">=</span><span class="p">{</span>
<span class="linenos" data-linenos="28 "></span>        <span class="s1">&#39;ReadCapacityUnits&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
<span class="linenos" data-linenos="29 "></span>        <span class="s1">&#39;WriteCapacityUnits&#39;</span><span class="p">:</span> <span class="mi">10</span>
<span class="linenos" data-linenos="30 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="31 "></span><span class="p">)</span>
<span class="linenos" data-linenos="32 "></span>
<span class="linenos" data-linenos="33 "></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estado:&quot;</span><span class="p">,</span> <span class="n">tabla</span><span class="o">.</span><span class="n">table_status</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">crearTMDB_filtered.py</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">resp</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">select_object_content</span><span class="p">(</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="n">Bucket</span><span class="o">=</span><span class="s1">&#39;s3severo2122python&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="n">Key</span><span class="o">=</span><span class="s1">&#39;TMDb_updated.CSV&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="n">ExpressionType</span><span class="o">=</span><span class="s1">&#39;SQL&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="n">Expression</span><span class="o">=</span><span class="s2">&quot;SELECT s.title, s.overview, s.vote_count, s.vote_average FROM s3object s WHERE cast(s.vote_count as int)&gt; 10000&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="n">InputSerialization</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;CSV&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;FileHeaderInfo&quot;</span><span class="p">:</span> <span class="s2">&quot;USE&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>                                <span class="s1">&#39;AllowQuotedRecordDelimiter&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
<span class="linenos" data-linenos="11 "></span>                        <span class="s1">&#39;CompressionType&#39;</span><span class="p">:</span> <span class="s1">&#39;NONE&#39;</span><span class="p">},</span>
<span class="linenos" data-linenos="12 "></span>    <span class="n">OutputSerialization</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;CSV&#39;</span><span class="p">:</span> <span class="p">{}},</span>
<span class="linenos" data-linenos="13 "></span><span class="p">)</span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span><span class="n">registros</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;title,overview,vote_count,vote_average</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
<span class="linenos" data-linenos="16 "></span><span class="k">for</span> <span class="n">evento</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;Payload&#39;</span><span class="p">]:</span>
<span class="linenos" data-linenos="17 "></span>    <span class="k">if</span> <span class="s1">&#39;Records&#39;</span> <span class="ow">in</span> <span class="n">evento</span><span class="p">:</span>
<span class="linenos" data-linenos="18 "></span>        <span class="n">registros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evento</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">][</span><span class="s1">&#39;Payload&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<span class="linenos" data-linenos="19 "></span>
<span class="linenos" data-linenos="20 "></span><span class="n">file_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">registros</span><span class="p">)</span>
<span class="linenos" data-linenos="21 "></span><span class="n">s3</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span><span class="n">Body</span><span class="o">=</span><span class="n">file_str</span><span class="p">,</span> <span class="n">Bucket</span><span class="o">=</span><span class="s1">&#39;s3severo2122python&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="22 "></span>            <span class="n">Key</span><span class="o">=</span><span class="s2">&quot;TMDb_filtered.CSV&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
<p>Si ejecutamos los tres programas uno detrás de otro, al crearse el fichero <code>TMDb_filtered.CSV</code>, automáticamente se ejecutará la función <em>serverless</em> y se rellenará la tabla <code>SeveroPeliculas</code>.</p>
<h3 id="destino">Destino<a class="headerlink" href="#destino" title="Permanent link">&para;</a></h3>
<p>Finalmente, si queremos que quede registrada nuestra operación, una posibilidad es crear un destino que se ejecute automáticamente. Para ello, vamos a hacer uso de una cola SQS en la cual se insertará un mensaje cada vez que se ejecute exitosamente nuestra función.</p>
<p>Entramos en el servicios SQS, y creamos una cola estándar con el nombre que queramos (en mi caso he elegido <code>etl5sqs</code>). Tras ello, desde el gráfico con el esquema de la función, sobre el botón de <code>+Agregar destino</code>, configuramos la cola SQS que acabamos de crear:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/05lambda-destino.png">
    <figcaption>Destino en AWS Lambda</figcaption>
</figure>

<p>Si hemos realizado todos los pasos, tendremos nuestra función asociada a un desencadenador y a un destino:</p>
<figure style="align: center;">
    <img src="../imagenes/etl/05lambda-diagrama.png">
    <figcaption>Diagrama completo en AWS Lambda</figcaption>
</figure>

<p>Si volvemos a ejecutar el <em>script</em> <code>crearTMDB_filtered.py</code> para que forzar la creación del fichero en S3 y que provoque que se lance la función, se insertará automáticamente un mensaje en la cola. Para comprobar la cola, una vez dentro de SQS y habiendo seleccionado la cola creada, mediante el botón superior de <em>Enviar y recibir mensajes</em>, entramos en la propia cola y podemos <em>sondear mensajes</em> para ver el contenido de la cola e inspeccionar los mensajes.</p>
<figure style="align: center;">
    <img src="../imagenes/etl/05lambda-sqs.png">
    <figcaption>Sondeando mensajes en SQS</figcaption>
</figure>

<h2 id="actividades">Actividades<a class="headerlink" href="#actividades" title="Permanent link">&para;</a></h2>
<p>Para las siguientes actividades, se pide entregar en Aules un zip con todo el código fuente y con una captura de todos los recursos AWS empleados (buckets S3, tabla/s DynamoDB, instancias RDS, función AWS Lambda, etc..).</p>
<ol>
<li>Realizar los casos de uso del 1 al 4.</li>
<li>(opcional) Realiza los casos de uso 5 y 6.</li>
</ol>
<h2 id="referencias">Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<ul>
<li>Python, Boto3, and AWS S3: Demystified: <a href="https://realpython.com/python-boto3-aws-s3/">https://realpython.com/python-boto3-aws-s3/</a></li>
<li><a href="https://highlandsolutions.com/blog/hands-on-examples-for-working-with-dynamodb-boto3-and-python">DynamoDB mediante Python</a></li>
<li><a href="https://www.fernandomc.com/posts/ten-examples-of-getting-data-from-dynamodb-with-python-and-boto3/">Ten Examples of Getting Data from DynamoDB with Python and Boto3</a></li>
<li><a href="https://medium.com/skyline-ai/dynamodb-insert-performance-basics-in-python-boto3-5bc01919c79f">DynamoDB Insert: Performance Basics in Python/Boto3</a></li>
<li><em>S3Select</em> mediante <em>Python</em>: <a href="https://towardsdatascience.com/ditch-the-database-20a5a0a1fb72">Ditch the Database</a></li>
</ul>
<!--
http://ramondario.com/processing-nyc-taxi-data-part-1-downloading.html
-->

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Volver al principio
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Pie">
      
        
        <a href="ingesta04nifi2.html" class="md-footer__link md-footer__link--prev" aria-label="Anterior: 4.- Nifi II" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              4.- Nifi II
            </div>
          </div>
        </a>
      
      
        
        <a href="bdaplicado01hadoop.html" class="md-footer__link md-footer__link--next" aria-label="Siguiente: 1.- Hadoop" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Siguiente
              </span>
              1.- Hadoop
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2021-2022 Aitor Medrano - Licencia CC BY-NC-SA
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/aitormedrano" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    <a href="mailto:<a.medrano@edu.gva.es>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM178.117 262.104C87.429 196.287 88.353 196.121 64 177.167V152c0-13.255 10.745-24 24-24h272c13.255 0 24 10.745 24 24v25.167c-24.371 18.969-23.434 19.124-114.117 84.938-10.5 7.655-31.392 26.12-45.883 25.894-14.503.218-35.367-18.227-45.883-25.895zM384 217.775V360c0 13.255-10.745 24-24 24H88c-13.255 0-24-10.745-24-24V217.775c13.958 10.794 33.329 25.236 95.303 70.214 14.162 10.341 37.975 32.145 64.694 32.01 26.887.134 51.037-22.041 64.72-32.025 61.958-44.965 81.325-59.406 95.283-70.199z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["header.autohide", "navigation.top", "navigation.expand", "navigation.tracking", "content.code.annotate"], "translations": {"clipboard.copy": "Copiar al portapapeles", "clipboard.copied": "Copiado al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.term.missing": "Falta", "select.version.title": "Seleccionar versi\u00f3n"}, "search": "../assets/javascripts/workers/search.092fa1f6.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.e3b2bf44.min.js"></script>
      
    
  </body>
</html>